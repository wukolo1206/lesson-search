<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
      background-color: #f8fafc;
    }

    /* å¡ç‰‡ç‰¹æ•ˆ */
    .card {
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
    }

    /* å½ˆå‡ºè¦–çª—ç‰¹æ•ˆ */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(2px);
    }

    .modal-container {
      height: 90vh;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    /* å·è»¸ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 5px;
      border: 2px solid #f1f1f1;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .loader {
      border-top-color: #3b82f6;
      animation: spinner 1.0s linear infinite;
    }

    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* æ‰‹æ©Ÿç‰ˆå½ˆå‡ºè¦–çª—ä¿®æ­£ */
    @media (max-width: 767px) {
      .modal-container {
        height: 95vh;
      }

      .modal-left-panel {
        max-height: 40vh;
        overflow-y: auto;
        border-right: none !important;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-right-panel {
        max-height: 55vh;
        overflow-y: auto;
      }
    }

    /* åˆ—å°æ¨£å¼ */
    @media print {
      body>*:not(#printArea) {
        display: none !important;
      }

      #printArea {
        display: block !important;
        position: static !important;
        width: 100% !important;
        font-family: "Microsoft JhengHei", sans-serif;
        font-size: 13pt;
        line-height: 1.8;
        color: #000;
      }

      #printArea h1 {
        font-size: 18pt;
        font-weight: bold;
        margin-bottom: 6pt;
      }

      #printArea .print-badge {
        display: inline-block;
        border: 1px solid #999;
        padding: 1pt 4pt;
        border-radius: 3pt;
        font-size: 10pt;
        margin-right: 4pt;
      }

      #printArea .print-section {
        margin-top: 14pt;
        padding-top: 10pt;
        border-top: 1pt solid #ccc;
      }

      #printArea .print-label {
        font-size: 9pt;
        font-weight: bold;
        color: #555;
        text-transform: uppercase;
        letter-spacing: 0.5pt;
      }

      #printArea .print-fulltext {
        font-size: 12pt;
        line-height: 2;
        white-space: pre-line;
        background: #f8f8f8;
        padding: 10pt;
        border: 1pt solid #ddd;
        border-radius: 4pt;
        margin-top: 6pt;
      }

      #printArea .print-question-block {
        margin-top: 16pt;
        padding: 10pt;
        border: 1pt solid #bbb;
        border-radius: 4pt;
        break-inside: avoid;
      }

      #printArea .print-misconception {
        background: #fff0f0;
        padding: 8pt;
        border-left: 3pt solid #e00;
        margin-top: 8pt;
      }

      #printArea .print-strategy {
        background: #f0fff4;
        padding: 8pt;
        border-left: 3pt solid #080;
        margin-top: 8pt;
      }
    }

    /* é¦–æ¬¡ä½¿ç”¨èªªæ˜è¦†å±¤ */
    #onboardingOverlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #onboardingBox {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 540px;
      width: 90%;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    }

    .onboard-tip {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .onboard-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      line-height: 1.4;
    }

    .copy-strategy-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bg-green-50:hover .copy-strategy-btn {
      opacity: 1;
    }

    /* ç°¡å ±æ¨¡å¼ */
    #presentModal {
      background: #0f172a;
      --pres-font-scale: 1;
    }

    #presentModal .pres-text {
      font-size: calc(clamp(1.1rem, 2vw, 1.5rem) * var(--pres-font-scale));
      line-height: 2.2;
    }

    #presentModal .pres-question {
      font-size: calc(clamp(1.2rem, 2.2vw, 1.7rem) * var(--pres-font-scale));
    }

    .present-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }

    .present-btn:hover {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
    }

    /* åˆ†éš”ç·šæ‹–æ›³ */
    #presDivider {
      width: 6px;
      cursor: col-resize;
      background: #334155;
      flex-shrink: 0;
      transition: background 0.2s;
      user-select: none;
    }

    #presDivider:hover,
    #presDivider.dragging {
      background: #3b82f6;
    }

    /* é¢æ¿éš±è— */
    #presLeftPanel.collapsed,
    #presRightPanel.collapsed {
      display: none;
    }

    .panel-toggle-btn {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .panel-toggle-btn.active {
      background: #1e40af;
      color: #bfdbfe;
    }

    /* æ•™å¸«/å­¸ç”Ÿæ¨¡å¼ */
    .teacher-only {
      display: none;
    }

    body.teacher-mode .teacher-only {
      display: block;
    }

    #modeToggleBtn.teacher {
      background: #d97706;
      border-color: #f59e0b;
      color: white;
    }

    #modeToggleBtn.student {
      background: #1e3a5f;
      border-color: #3b82f6;
      color: #93c5fd;
    }
  </style>
</head>

<body class="p-4 md:p-6 min-h-screen text-gray-800 bg-slate-50">

  <div class="max-w-7xl mx-auto">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold text-gray-900 mb-1 tracking-tight">ğŸ“š é–±è®€æ•™å­¸ç­–ç•¥è³‡æ–™åº«</h1>
      <p class="text-gray-500 text-sm">æ”¯æ´ä¾ã€ŒèªçŸ¥æ­·ç¨‹ã€å¿«ç¯©æ–‡ç« ï¼Œä¸€æ¬¡æª¢è¦–å®Œæ•´æ•™å­¸ç­–ç•¥</p>
    </header>

    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 sticky top-2 z-20 border border-gray-200">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <select id="yearFilter" onchange="filterData()"
          class="w-full p-2.5 border rounded-lg bg-gray-50 font-medium cursor-pointer hover:bg-gray-100 transition">
          <option value="">ğŸ“… å…¨éƒ¨å¹´åº¦</option>
        </select>
        <select id="gradeFilter" onchange="filterData()"
          class="w-full p-2.5 border rounded-lg bg-gray-50 font-medium cursor-pointer hover:bg-gray-100 transition">
          <option value="">ğŸ« å…¨éƒ¨å¹´ç´š</option>
        </select>
        <select id="processFilter" onchange="filterData()"
          class="w-full p-2.5 border rounded-lg bg-gray-50 font-medium cursor-pointer hover:bg-gray-100 transition text-blue-700 font-bold bg-blue-50/50">
          <option value="">ğŸ§  å…¨éƒ¨èªçŸ¥æ­·ç¨‹</option>
        </select>
        <select id="genreFilter" onchange="filterData()"
          class="w-full p-2.5 border rounded-lg bg-gray-50 font-medium cursor-pointer hover:bg-gray-100 transition">
          <option value="">ğŸ“– å…¨éƒ¨æ–‡é«”</option>
        </select>
        <input type="text" id="searchInput" onkeyup="filterData()" placeholder="æœå°‹æ–‡ç« æ¨™é¡Œ..."
          class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="mt-2 text-right text-sm text-gray-500">å…±æ‰¾åˆ° <span id="count"
          class="text-blue-600 font-bold text-lg">0</span> ç¯‡æ•™æ</div>
    </div>

    <div id="loading" class="flex justify-center py-20">
      <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
    </div>

    <div id="errorMsg" class="hidden mx-auto max-w-lg mt-10 p-5 bg-red-50 border border-red-300 rounded-lg text-center">
      <p class="text-red-700 font-bold text-lg mb-2">âš ï¸ ç„¡æ³•é€£æ¥è³‡æ–™åº«</p>
      <p id="errorDetail" class="text-red-600 text-sm"></p>
    </div>

    <div id="cardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-10"></div>
  </div>

  <div id="detailModal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4"
    onclick="closeModal(event)">
    <div
      class="bg-white rounded-2xl shadow-2xl w-full max-w-[90rem] modal-container overflow-hidden ring-1 ring-gray-900/5"
      onclick="event.stopPropagation()">

      <div class="px-6 py-4 border-b flex-none bg-gray-50 flex justify-between items-center z-10 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center gap-3 overflow-hidden">
          <div class="flex gap-2 flex-shrink-0">
            <span id="modalGrade" class="bg-blue-600 text-white text-sm font-bold px-2.5 py-1 rounded"></span>
            <span id="modalGenre"
              class="bg-orange-100 text-orange-700 text-sm font-bold px-2.5 py-1 rounded border border-orange-200"></span>
          </div>
          <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 truncate"></h2>
          <span id="modalQuestionCount"
            class="bg-gray-200 text-gray-700 text-xs font-bold px-2 py-1 rounded-full"></span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="printModal()"
            class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100 transition" title="åˆ—å°">
            ğŸ–¨ï¸
          </button>
          <button onclick="closeModal()"
            class="text-gray-400 hover:text-red-600 p-2 rounded-full hover:bg-gray-200 transition">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">

        <div class="modal-left-panel md:w-5/12 flex flex-col border-r border-gray-200 bg-gray-50 md:h-full">
          <div class="p-3 bg-gray-100 border-b border-gray-200 flex justify-between items-center flex-none">
            <h3 class="text-sm font-bold text-gray-600 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
              </svg>
              æ–‡ç« å…¨æ–‡
            </h3>
          </div>
          <div class="p-6 overflow-y-auto flex-grow scroll-smooth">
            <div id="modalFullText"
              class="text-lg leading-9 text-gray-800 font-serif whitespace-pre-line text-justify tracking-wide"></div>
          </div>
        </div>

        <div class="modal-right-panel md:w-7/12 flex flex-col bg-white md:h-full relative">
          <div class="p-3 bg-white border-b border-gray-100 shadow-sm z-10 flex-none sticky top-0">
            <h3 class="text-sm font-bold text-blue-600 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                </path>
              </svg>
              ç›¸é—œè©¦é¡Œèˆ‡æ•™å­¸ç­–ç•¥
            </h3>
          </div>

          <div id="modalQuestionsContainer" class="p-6 overflow-y-auto flex-grow pb-24 space-y-12">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== ç°¡å ±æ¨¡å¼ Overlay ===================== -->
  <div id="presentModal" class="fixed inset-0 z-[100] hidden flex-col text-white" style="display:none;">
    <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
    <div
      class="flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-slate-700 flex-shrink-0 gap-3 flex-wrap">
      <div class="flex items-center gap-2">
        <span id="presGrade" class="bg-blue-500 text-white text-sm font-bold px-2 py-1 rounded"></span>
        <span id="presGenre" class="bg-amber-500 text-white text-sm font-bold px-2 py-1 rounded"></span>
        <h2 id="presTitle" class="text-lg font-bold text-white"></h2>
      </div>
      <!-- é¢æ¿åˆ‡æ›æŒ‰éˆ• -->
      <div class="flex items-center gap-2">
        <span class="text-slate-500 text-xs">é¡¯ç¤ºï¼š</span>
        <button id="toggleLeft" onclick="togglePanel('left')" class="panel-toggle-btn active">ğŸ“„ æ–‡ç« </button>
        <button id="toggleRight" onclick="togglePanel('right')" class="panel-toggle-btn active">â“ è©¦é¡Œ</button>
      </div>
      <!-- æ•™å¸«/å­¸ç”Ÿæ¨¡å¼åˆ‡æ› -->
      <div class="flex items-center gap-2">
        <button id="modeToggleBtn" onclick="toggleTeacherMode()"
          class="student px-3 py-1 rounded border text-xs font-bold transition">
          ğŸ‘¨â€ğŸ« æ•™å¸«æ¨¡å¼
        </button>
      </div>
      <div class="flex items-center gap-3">
        <span id="presCounter" class="text-slate-300 text-sm font-mono">1 / 1</span>
        <!-- å­—é«”å¤§å°èª¿æ•´ -->
        <div class="flex items-center gap-1">
          <button onclick="changePresFont(-0.1)"
            class="w-7 h-7 flex items-center justify-center rounded bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold transition" title="ç¸®å°å­—é«”">A-</button>
          <button onclick="resetPresFont()"
            id="presFontLabel"
            class="px-2 h-7 flex items-center justify-center rounded bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs font-mono transition" title="é‡è¨­å­—é«”å¤§å°">100%</button>
          <button onclick="changePresFont(0.1)"
            class="w-7 h-7 flex items-center justify-center rounded bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold transition" title="æ”¾å¤§å­—é«”">A+</button>
        </div>
        <button onclick="closePresentMode()"
          class="text-slate-400 hover:text-white px-3 py-1 rounded border border-slate-600 hover:border-white transition text-sm">
          âœ• çµæŸç°¡å ±
        </button>
      </div>
    </div>

    <!-- ä¸»å…§å®¹å€ï¼šå·¦æ–‡ç«  + æ‹–æ›³åˆ†éš”ç·š + å³é¡Œç›® -->
    <div id="presContentArea" class="flex flex-1 overflow-hidden select-none">
      <!-- å·¦ï¼šæ–‡ç« å…¨æ–‡ -->
      <div id="presLeftPanel" class="flex flex-col border-r border-slate-700 bg-slate-900 overflow-hidden"
        style="width:41.67%">
        <div class="px-4 py-2 bg-slate-800 text-slate-400 text-xs font-bold uppercase tracking-widest flex-shrink-0">ğŸ“„
          æ–‡ç« å…¨æ–‡</div>
        <div class="flex-1 overflow-y-auto p-8">
          <div id="presFullText"
            class="pres-text text-slate-200 font-serif whitespace-pre-line leading-loose tracking-wide"></div>
        </div>
      </div>

      <!-- æ‹–æ›³åˆ†éš”ç·š -->
      <div id="presDivider" onmousedown="startDrag(event)"></div>

      <!-- å³ï¼šé¡Œç›®ï¼ˆä¸€æ¬¡ä¸€é¡Œï¼‰ -->
      <div id="presRightPanel" class="flex flex-col bg-slate-950 overflow-hidden flex-1">
        <div class="px-4 py-2 bg-slate-800 text-blue-400 text-xs font-bold uppercase tracking-widest flex-shrink-0">â“ è©¦é¡Œ
        </div>
        <div class="flex-1 overflow-y-auto p-8">
          <div class="flex flex-wrap items-center gap-2 mb-6">
            <span id="presCognitive" class="bg-blue-800 text-blue-200 text-sm font-bold px-3 py-1 rounded"></span>
            <span id="presMaterial" class="bg-purple-900 text-purple-300 text-sm font-bold px-3 py-1 rounded"></span>
            <span id="presPoint" class="text-slate-400 text-sm"></span>
          </div>
          <div id="presQuestion" class="pres-question text-white font-bold leading-relaxed whitespace-pre-line"></div>

          <!-- æ•™å¸«æ¨¡å¼æ‰é¡¯ç¤ºçš„å€å¡Š -->
          <div class="teacher-only mt-6 space-y-4">
            <div class="bg-red-950 border border-red-800 rounded-xl p-5">
              <p class="text-red-400 text-xs font-bold mb-2 uppercase tracking-widest">âš ï¸ å­¸ç”Ÿè¿·æ€ / éŒ¯èª¤åŸå› </p>
              <p id="presMisconception" class="text-red-200 text-base leading-relaxed"></p>
            </div>
            <div class="bg-green-950 border border-green-800 rounded-xl p-5">
              <p class="text-green-400 text-xs font-bold mb-2 uppercase tracking-widest">ğŸ’¡ æ•™å­¸ç­–ç•¥</p>
              <p id="presStrategyName" class="text-green-300 font-bold text-base mb-3"></p>
              <div id="presStrategySteps"
                class="text-green-100 text-base leading-8 whitespace-pre-line border-l-2 border-green-600 pl-4"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å°è¦½ -->
    <div class="flex items-center justify-center gap-6 py-3 bg-slate-800 border-t border-slate-700 flex-shrink-0">
      <button id="presPrevBtn" onclick="navigatePresentation(-1)"
        class="flex items-center gap-2 px-6 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 transition disabled:opacity-30 disabled:cursor-not-allowed font-bold">
        â† ä¸Šä¸€é¡Œ
      </button>
      <div class="flex gap-2" id="presDots"></div>
      <button id="presNextBtn" onclick="navigatePresentation(1)"
        class="flex items-center gap-2 px-6 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 transition disabled:opacity-30 disabled:cursor-not-allowed font-bold">
        ä¸‹ä¸€é¡Œ â†’
      </button>
    </div>
  </div>
  <!-- ===================== ç°¡å ±æ¨¡å¼ END ===================== -->

  <script>
    let rawData = [];
    let groupedData = [];
    let currentFilteredData = [];

    window.onload = function () {
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(function(error) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('errorMsg').classList.remove('hidden');
          document.getElementById('errorDetail').textContent = error.message || JSON.stringify(error);
        })
        .getData();
    };

    function onSuccess(data) {
      rawData = data;
      document.getElementById('loading').style.display = 'none';

      // åˆ†çµ„ä¸¦æå–æ‰€æœ‰èªçŸ¥æ­·ç¨‹
      groupedData = groupDataByArticle(rawData);

      initFilters();
      currentFilteredData = groupedData;
      renderCards(groupedData);
      showOnboarding(); // é¦–æ¬¡ä½¿ç”¨èªªæ˜
    }

    // ===========================
    // è³‡æ–™è™•ç†ï¼šåˆ†çµ„ + æ”¶é›†èªçŸ¥æ­·ç¨‹
    // ===========================
    function groupDataByArticle(data) {
      const groups = {};

      data.forEach(row => {
        const title = row['æ–‡æœ¬æ¨™é¡Œ'] || 'ç„¡æ¨™é¡Œ';
        const year = row['å¹´åº¦'] || '';
  const grade = row['å¹´ç´š'] || '';
        const key = `${year}_${grade}_${title}`;

        if (!groups[key]) {
          groups[key] = {
            'è­˜åˆ¥ç¢¼': key,
            'å¹´åº¦': year,
            'å¹´ç´š': grade,
            'æ–‡æœ¬æ¨™é¡Œ': title,
            'æ–‡æœ¬é¡å‹': row['æ–‡æœ¬é¡å‹'],
            'æ–‡ç« å…¨æ–‡': row['æ–‡ç« å…¨æ–‡'],
            'é¡Œç›®åˆ—è¡¨': [],
            'èªçŸ¥æ­·ç¨‹é›†åˆ': new Set() // æ–°å¢ï¼šç”¨ä¾†æ”¶é›†é€™ç¯‡æ–‡ç« æ¶µè“‹çš„æ‰€æœ‰èªçŸ¥æ­·ç¨‹
          };
        }

        if (!groups[key]['æ–‡ç« å…¨æ–‡'] && row['æ–‡ç« å…¨æ–‡']) {
          groups[key]['æ–‡ç« å…¨æ–‡'] = row['æ–‡ç« å…¨æ–‡'];
        }

        const process = row['èªçŸ¥æ­·ç¨‹'];
        if (process) {
          groups[key]['èªçŸ¥æ­·ç¨‹é›†åˆ'].add(process); // æ”¶é›†ä¸é‡è¤‡çš„èªçŸ¥æ­·ç¨‹
        }

        groups[key]['é¡Œç›®åˆ—è¡¨'].push({
          'è€ƒé»': row['è€ƒé»/é¡Œç›®é‡é»'],
          'èªçŸ¥æ­·ç¨‹': process,
          'å®Œæ•´é¡Œç›®': row['å®Œæ•´é¡Œç›®'],
          'å­¸ç”Ÿè¿·æ€': row['å­¸ç”Ÿè¿·æ€/éŒ¯èª¤åŸå› '],
          'ç­–ç•¥åç¨±': row['æ•™å­¸ç­–ç•¥åç¨±'],
          'ç­–ç•¥æ­¥é©Ÿ': row['å…·é«”æ•™å­¸æ­¥é©Ÿ'],
          'æ•™æç·¨è™Ÿ': row['å°æ‡‰æ•™æç·¨è™Ÿ']
        });
      });

      // å°‡ Set è½‰å› Array ä»¥ä¾¿æ¸²æŸ“
      return Object.values(groups).map(g => {
        g['èªçŸ¥æ­·ç¨‹åˆ—è¡¨'] = Array.from(g['èªçŸ¥æ­·ç¨‹é›†åˆ']).sort();
        return g;
      });
    }

    // ===========================
    // 1. åˆå§‹åŒ–ç¯©é¸é¸å–® (ä¿®æ”¹ç‰ˆï¼šæ–‡é«”æ”¹ç‚ºå›ºå®šé¸é …)
    // ===========================
    function initFilters() {
      populateSelect('yearFilter', 'å¹´åº¦');
      populateSelect('gradeFilter', 'å¹´ç´š');

      // -å§‹ï¼šæ–‡é«”é¸å–®ä¸å†è‡ªå‹•æŠ“å–ï¼Œè€Œæ˜¯å›ºå®šé€™å››å€‹ ---
      const genreSelect = document.getElementById('genreFilter');
      genreSelect.innerHTML = '<option value="">ğŸ“– å…¨éƒ¨</option>'; // æ¸…ç©ºä¸¦é‡è¨­é è¨­å€¼

      const mainGenres = ['è¨˜æ•˜æ–‡', 'èªªæ˜æ–‡', 'æ‡‰ç”¨æ–‡', 'ç«¥è©©'];
      mainGenres.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        genreSelect.appendChild(option);
     });
      // --- ä¿®æ”¹çµæŸ ---

      // èªçŸ¥æ­·ç¨‹ç¶­æŒåŸæ¨£
      const processSelect = document.getElementById('processFilter');
      const processes = new Set();
      rawData.forEach(item => {
        if (item['èªçŸ¥æ­·ç¨‹']) processes.add(item['èªçŸ¥æ­·ç¨‹']);
      });
      [...processes].forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        processSelect.appendChild(option);
      });
    }

    // å…¶ä»– populateSelect ç¶­æŒä¸è®Š...
    function populateSelect(elementId, key) {
      const select = document.getElementById(elementId);
      const uniqueValues = [...new Set(groupedData.map(item => String(item[key] || '')).filter(v => v))].sort();
   niqueValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    function populateSelect(elementId, key) {
      const select = document.getElementById(elementId);
      const uniqueValues = [...new Set(groupedData.map(item => String(item[key] || '')).filter(v => v))].sort();
      uniqueValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    // ===========================
    // æœå°‹é‚è¼¯ï¼šåŒ…å«èªçŸ¥æ­·ç¨‹åˆ¤æ–·
    // ===========================
    function filterData() {
      const year = document.getElementById('yearFilter').value;
      const grade = document.getElementById('gradeFilter').value;
      const genre = document.getElementById('genreFilter').value; // é€™è£¡æŠ“åˆ°çš„æ˜¯å››å¤§é¡ä¹‹ä¸€
      const process = document.getElementById('processFilter').value;
      const keyword = document.getElementById('searchInput').value.toLowerCase();

      const filtered = groupedData.filter(article => {
        const itemYear = article['å¹´åº¦'] ? String(article['å¹´åº¦']) : '';
        const itemGrade = article['å¹´ç´š'] || '';
        const itemGenre = article['æ–‡æœ¬é¡å‹'] || ''; // é€™æ˜¯ Excel è£¡çš„è©³ç´°åˆ†é¡ (å¦‚: å¯“è¨€)

        // --- æ–‡é«”æ™ºæ…§å°æ‡‰é‚è¼¯ ---
        let isGenreMatch = false;
        if (genre === '') {
          isGenreMatch = true; // æ²’é¸å°±å…¨éƒ½è¦
        } else if (genre === 'è¨˜æ•˜æ–‡') {
          // é¸è¨˜æ•˜æ–‡æ™‚ï¼ŒåŒæ™‚è¦æŠŠ æ•…äº‹ã€å¯“è¨€ã€å‚³èªªã€å‚³è¨˜... éƒ½ç®—é€²ä¾†
          if (itemGenre.includes('è¨˜æ•˜') || itemGenre.includes('æ•…äº‹') || itemGenre.includes('å¯“è¨€') || itemGenre.includes('å‚³èªª') || itemGenre.includes('å‚³è¨˜') || itemGenre.includes('å°èªª')) isGenreMatch = true;
        } else if (genre === 'èªªæ˜æ–‡') {
          // é¸èªªæ˜æ–‡æ™‚ï¼Œè¦æŠŠ éé€£çºŒæ–‡æœ¬ã€åœ–æ–‡... éƒ½ç®—é€²ä¾†
          if (itemGenre.includes('èªªæ˜') || itemGenre.includes('éé€£çºŒ') || itemGenre.includes('åœ–æ–‡') || itemGenre.includes('ç§‘æ™®')) isGenreMatch = true;
        } else if (genre === 'æ‡‰ç”¨æ–‡') {
          // é¸æ‡‰ç”¨æ–‡æ™‚ï¼Œè¦æŠŠ æµ·å ±ã€é€šå‘Šã€æ›¸ä¿¡... éƒ½ç®—é€²ä¾†
          if (itemGenre.includes('æ‡‰ç”¨') || itemGenre.includes('æ›¸ä¿¡') || itemGenre.includes('ä¾¿æ¢') || itemGenre.includes('æµ·å ±') || itemGenre.includes('å•Ÿäº‹')) isGenreMatch = true;
        } else if (genre === 'ç«¥è©©') {
          // é¸ç«¥è©©æ™‚ï¼Œè¦æŠŠ è©©æ­Œ éƒ½ç®—é€²ä¾†
          if (itemGenre.includes('è©©')) isGenreMatch = true;
        }
        // èªçŸ¥æ­·ç¨‹é‚è¼¯
        const hasProcess = process === '' || article['èªçŸ¥æ­·ç¨‹åˆ—è¡¨'].includes(process);

        const contentString = (article['æ–‡æœ¬æ¨™é¡Œ'] + JSON.stringify(article['é¡Œç›®åˆ—è¡¨'])).toLowerCase();

        return (year === '' || itemYear === year) &&
          (grade === '' || itemGrade === grade) &&
          isGenreMatch && // ä½¿ç”¨æ–°çš„åˆ¤æ–·è®Šæ•¸
          hasProcess &&
          (keyword === '' || contentString.includes(keyword));
      });

      currentFilteredData = filtered;
      renderCards(filtered);
    }

    function renderCards(data) {
      const container = document.getElementById('cardContainer');
      document.getElementById('count').textContent = data.length;
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">ç„¡ç¬¦åˆè³‡æ–™</div>';
        return;
      }

      data.forEach((article, index) => {
        const qCount = article['é¡Œç›®åˆ—è¡¨'].length;

        // ç”¢ç”Ÿ (Badges)
        const processBadges = article['èªçŸ¥æ­·ç¨‹åˆ—è¡¨'].map(p =>
          `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded border border-gray-200 mr-1 mb-1 inline-block">${p}</span>`
        ).join('');

        const card = `
            <div class="card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden h-full relative group">
              <div class="px-5 pt-4 flex justify-between items-start">
                  <div class="flex gap-2">
                     <span class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded">${article['å¹´åº¦']}</span>
                     <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">${article['å¹´ç´š']}</span>
                  </div>
                  <span class="bg-orange-50 text-orange-700 text-xs font-bold px-2 py-1 rounded border border-orange-100">${article['æ–‡æœ¬é¡å‹']}</span>
              </div>
              
              <div onclick="openModal(${index})" class="px-5 pb-20 flex-grow pt-3 cursor-pointer">
                <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition">${article['æ–‡æœ¬æ¨™é¡Œ']}</h3>
                
                <div class="mb-3">
                  <span class="inline-block bg-blue-50 text-blue-600 text-xs font-bold px-2 py-1 rounded-full mb-2">
                    åŒ…å« ${qCount} å€‹è©¦é¡Œ
                  </span>
                  <div class="flex flex-wrap mt-1">
                    ${processBadges}
                  </div>
                </div>
              </div>
              
              <div class="absolute bottom-0 left-0 right-0 flex border-t border-gray-100">
                 <button onclick="openModal(${index})" class="flex-1 py-3 text-blue-600 font-bold text-sm flex items-center justify-center gap-1 hover:bg-gray-50 transition border-r border-gray-100">
                    è©³ç´°è³‡è¨Š â†’
                 </button>
                 <button onclick="openPresentMode(${index}, event)" class="px-4 py-3 present-btn text-white font-bold text-sm flex items-center justify-center gap-1 hover:opacity-90 transition" title="ç°¡å ±æ¨¡å¼">
                    ğŸ“º
                 </button>
              </div>
            </div>
          `;
        container.innerHTML += card;
      });
    }

    // ===========================
    // å½ˆå‡ºè¦–çª—ï¼šæ™ºæ…§èšç„¦ç‰ˆ
    // ===================
    function openModal(index) {
      const article = currentFilteredData[index];
      if (!article) return;
      // 1. å–å¾—ç›®å‰ä½¿ç”¨è€…é¸äº†å“ªå€‹èªçŸ¥æ­·ç¨‹
      const selectedProcess = document.getElementById('processFilter').value;

      // åŸºæœ¬è³‡æ–™å¡«å¯«
      document.getElementById('modalGrade').textContent = article['å¹´ç´š'];
      document.getElementById('modalGenre').textContent = article['æ–‡æœ¬é¡å‹'];
      document.getElementById('modalTitle').textContent = article['æ–‡æœ¬æ¨™é¡Œ'];
      document.getElementById('modalQuestionCount').textContent = `å…± ${article['é¡Œç›®åˆ—è¡¨'].length} é¡Œ`;
      document.getElementById('modalFullText').textContent = article['æ–‡ç« å…¨æ–‡'] || 'ï¼ˆå°šç„¡å…¨æ–‡è³‡æ–™ï¼‰';

      const container = document.getElementById('modalQuestionsContainer');
      container.innerHTML = '';

      // ç”¨ä¾†è¨˜éŒ„ç¬¬ä¸€å€‹ç¬¦åˆæ¢ä»¶çš„é¡Œç›® IDï¼Œç¨å¾Œè‡ªå‹•æ²å‹•ç”¨
      let firstMatchId = null;
      article['é¡Œç›®åˆ—è¡¨'].forEach((q, i) => {
        // åˆ¤æ–·é€™ä¸€é¡Œæ˜¯å¦ç¬¦åˆç›®å‰çš„ç¯©é¸æ¢ä»¶
        // å¦‚æœæ²’é¸ç¯©é¸(selectedProcess==='')ï¼Œå‰‡æ¯ä¸€é¡Œéƒ½ç®— isMatch
        const isMatch = selectedProcess === '' || q['èªçŸ¥æ­·ç¨‹'] === selectedProcess;

        // æ¨£å¼é‚è¼¯ï¼š
        // å¦‚æœç¬¦åˆï¼šæ­£å¸¸é¡¯ç¤º + è—è‰²ç²—é‚Šæ¡† + èƒŒæ™¯å¾®äº®
        // å¦‚æœä¸ç¬¦ï¼šåŠé€æ˜ (opacity-40) + ç°è‰²é‚Šæ¡†
        let containerClass = ""; let badgeHtml = "";

        if (isMatch) {
          containerClass = "border-l-8 border-blue-500 bg-blue-50/20 shadow-sm ring-1 ring-blue-100";
          // å¦‚æœæœ‰é¸ç¯©é¸æ¢ä»¶ï¼Œæ‰é¡¯ç¤ºã€Œå‘½ä¸­ã€æ¨™ç±¤
          if (selectedProcess !== '') {
            badgeHtml = `<span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm animate-pulse">ğŸ¯ æœ¬æ¬¡ç¯©é¸é‡é»</span>`;
            // è¨˜éŒ„ç¬¬ä¸€å€‹å‘½ä¸­çš„ ID
            if (!firstMatchId) firstMatchId = `question-${i}`;
          }
        } else {
          containerClass = "border-l-4 border-gray-200 opacity-40 hover:opacity-100 transition-opacity grayscale hover:grayscale-0"; // å¹³å¸¸æ·¡åŒ–ï¼Œæ»‘é¼ ç§»éå»æœƒè®Šæ¸…æ¥š
        }

        // èªçŸ¥æ­·ç¨‹æ¨™ç±¤é¡è‰² (å‘½ä¸­æ™‚è®Šæ·±è—ï¼Œæœªå‘½ä¸­è®Šç°)
        const processTagColor = isMatch
          ? "bg-blue-100 text-blue-700 border-blue-200"
          : "bg-gray-100 text-gray-500 border-gray-200";

        const questionBlock = `
             <div id="question-${i}" class="relative pl-6 py-4 rounded-r-xl transition-all duration-300 ${containerClass} mb-8">
                
                <div class="absolute -left-[1.2rem] top-4 ${isMatch ? 'bg-blue-600 text-white ring-4 ring-blue-100' : 'bg-gray-200 text-gray-500'} font-bold w-9 h-9 rounded-full flex items-center justify-center border-2 border-white shadow-sm z-10">
                  ${i + 1}
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-3">
                   ${badgeHtml}
                   <span class="${processTagColor} text-xs font-bold px-2 py-0.5 rounded border">${q['èªçŸ¥æ­·ç¨‹'] || 'æœªæ¨™ç¤º'}</span>
                   <span class="bg-purple-50 text-purple-700 text-xs font-bold px-2 py-0.5 rounded border border-purple-100">æ•™æ: ${q['æ•™æç·¨è™Ÿ'] || '--'}</span>
                </div>

                <div class="mb-4">
                   <h4 class="font-bold text-lg text-gray-900 mb-2">${q['è€ƒé»'] || 'ç„¡è€ƒé»èªªæ˜'}</h4>
                   <div class="bg-white p-4 rounded-lg border ${isMatch ? 'border-blue-200' : 'border-gray-200'} text-gray-800 text-base whitespace-pre-line shadow-sm">
                     ${q['å®Œæ•´é¡Œç›®'] || q['è€ƒé»'] || 'ï¼ˆç„¡å®Œæ•´é¡Œç›®ï¼‰'}
                   </div>
                </div>

                <div class="mb-4 bg-red-50 p-4 rounded-lg border border-red-100">
                    <p class="text-xs text-red-500 font-bold mb-1">âš ï¸ å­¸ç”Ÿè¿·æ€</p>
                    <p class="text-sm text-gray-800">${q['å­¸ç”Ÿè¿·æ€'] || 'ç„¡è³‡æ–™'}</p>
                </div>

                 <div class="bg-green-50 p-5 rounded-xl border border-green-100">
                    <div class="flex items-center justify-between gap-2 mb-3">
                      <div class="flex items-center gap-2">
                        <span class="bg-green-600 text-white text-xs font-bold px-2 py-0.5 rounded">ç­–ç•¥</span>
                        <h5 class="text-base font-bold text-green-800">${q['ç­–ç•¥åç¨±'] || 'æœªå‘½å'}</h5>
                      </div>
                      <button onclick="copyStrategy(this)" data-text="ç­–ç•¥ï¼š${q['ç­–ç•¥åç¨±'] || ''}
${q['ç­–ç•¥æ­¥é©Ÿ'] || ''}"
                        class="copy-strategy-btn text-xs text-green-700 border border-green-300 px-2 py-0.5 rounded hover:bg-green-100 transition" title="è¤‡è£½ç­–ç•¥">
                        ğŸ“‹ è¤‡è£½
                      </button>
                    </div>
                    <div class="text-gray-700 text-base leading-7 whitespace-pre-line pl-2 border-l-2 border-green-300">
                       ${q['ç­–ç•¥æ­¥é©Ÿ'] || 'ç„¡æ­¥é©Ÿè³‡æ–™'}
                    </div>
                 </div>
             </div>
           `;
        container.innerHTML += questionBlock;
      });

      // é¡¯ç¤ºè¦–çª—
      const modal = document.getElementById('detailModal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // è‡ªå‹•æ²å‹•åˆ°ç¬¬ä¸€å€‹ç¬¦åˆçš„é¡Œç›® (å»¶é²ä¸€ä¸‹ç¢ºä¿æ¸²æŸ“å®Œæˆ)
      if (firstMatchId) {
        setTimeout(() => {
          const target = document.getElementById(firstMatchId);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      }
    }

    function closeModal(event) {
      if (event && event.target.id !== 'detailModal') return;
      document.getElementById('detailModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function printModal() {
      const title = document.getElementById('modalTitle').textContent;
      const grade = document.getElementById('modalGrade').textContent;
      const genre = document.getElementById('modalGenre').textContent;
      const fullText = document.getElementById('modalFullText').textContent;
      const currentArticle = currentFilteredData.find(a => a['æ–‡æœ¬æ¨™é¡Œ'] === title);
      if (!currentArticle) { window.print(); return; }

      let printHtml = `
        <h1>${title}</h1>
        <div style="margin-bottom:10pt">
          <span class="print-badge">${grade}</span>
          <span class="print-badge">${genre}</span>
          <span class="print-badge">å…± ${currentArticle['é¡Œç›®åˆ—è¡¨'].length} é¡Œ</span>
        </div>
        <div class="print-section">
          <div class="print-label">ğŸ“„ æ–‡ç« å…¨æ–‡</div>
          <div class="print-fulltext">${fullText}</div>
        </div>
        <div class="print-section">
          <div class="print-label">â“ è©¦é¡Œèˆ‡æ•™å­¸ç­–ç•¥</div>`;

      currentArticle['é¡Œç›®åˆ—è¡¨'].forEach((q, i) => {
        printHtml += `
          <div class="print-question-block">
            <div style="font-size:9pt;color:#555;margin-bottom:6pt">
              ç¬¬ ${i + 1} é¡Œã€€èªçŸ¥æ­·ç¨‹ï¼š${q['èªçŸ¥æ­·ç¨‹'] || '--'}ã€€æ•™æï¼š${q['æ•™æç·¨è™Ÿ'] || '--'}
            </div>
            <div style="font-weight:bold;font-size:12pt;margin-bottom:6pt">${q['è€ƒé»'] || ''}</div>
            <div style="white-space:pre-line;padding:6pt;border:1pt solid #ddd;border-radius:3pt">${q['å®Œæ•´é¡Œç›®'] || q['è€ƒé»'] || ''}</div>
            <div class="print-misconception"><strong>âš ï¸ å­¸ç”Ÿè¿·æ€ï¼š</strong>${q['å­¸ç”Ÿè¿·æ€'] || 'ç„¡è³‡æ–™'}</div>
            <div class="print-strategy"><strong>æ•™å­¸ç­–ç•¥ã€Œ${q['ç­–ç•¥åç¨±'] || ''}ã€ï¼š</strong><br>${q['ç­–ç•¥æ­¥é©Ÿ'] || 'ç„¡æ­¥é©Ÿè³‡æ–™'}</div>
          </div>`;
      });

      printHtml += `</div>`;

      // ç›´æ¥å°‡ printArea åŠ åˆ° bodyï¼ˆä¸å¤šä¸€å±¤åŒ…è£ï¼‰
      const div = document.createElement('div');
      div.id = 'printArea';
      div.innerHTML = printHtml;
      document.body.appendChild(div);
      window.print();
      document.body.removeChild(div);
    }


    // =============================================
    // ç°¡å ±æ¨¡å¼
    // =============================================
    let presArticle = null;
    let presIndex = 0;
    let presFontScale = 1;

    function changePresFont(delta) {
      presFontScale = Math.min(2.0, Math.max(0.5, presFontScale + delta));
      document.getElementById('presentModal').style.setProperty('--pres-font-scale', presFontScale);
      document.getElementById('presFontLabel').textContent = Math.round(presFontScale * 100) + '%';
    }

    function resetPresFont() {
      presFontScale = 1;
      document.getElementById('presentModal').style.setProperty('--pres-font-scale', 1);
      document.getElementById('presFontLabel').textContent = '100%';
    }

    function openPresentMode(index, event) {
      if (event) event.stopPropagation();
      presArticle = currentFilteredData[index];
      if (!presArticle) return;
      presIndex = 0;

      document.getElementById('presTitle').textContent = presArticle['æ–‡æœ¬æ¨™é¡Œ'];
      document.getElementById('presGrade').textContent = presArticle['å¹´ç´š'];
      document.getElementById('presGenre').textContent = presArticle['æ–‡æœ¬é¡å‹'];
      document.getElementById('presFullText').textContent = presArticle['æ–‡ç« å…¨æ–‡'] || 'ï¼ˆå°šç„¡å…¨æ–‡è³‡æ–™ï¼‰';

      renderPresQuestion();

      const modal = document.getElementById('presentModal');
      modal.style.display = 'flex';
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';

      document.addEventListener('keydown', handlePresKey);
    }

    function renderPresQuestion() {
      const q = presArticle['é¡Œç›®åˆ—è¡¨'][presIndex];
      const total = presArticle['é¡Œç›®åˆ—è¡¨'].length;

      document.getElementById('presCounter').textContent = `${presIndex + 1} / ${total}`;
      document.getElementById('presCognitive').textContent = q['èªçŸ¥æ­·ç¨‹'] || 'æœªæ¨™ç¤º';
      document.getElementById('presMaterial').textContent = `æ•™æ: ${q['æ•™æç·¨è™Ÿ'] || '--'}`;
      document.getElementById('presPoint').textContent = q['è€ƒé»'] || '';
      document.getElementById('presQuestion').textContent = q['å®Œæ•´é¡Œç›®'] || q['è€ƒé»'] || 'ï¼ˆç„¡é¡Œç›®ï¼‰';

      // æ•™å¸«æ¨¡å¼å€å¡Š
      document.getElementById('presMisconception').textContent = q['å­¸ç”Ÿè¿·æ€'] || 'ç„¡è³‡æ–™';
      document.getElementById('presStrategyName').textContent = q['ç­–ç•¥åç¨±'] || 'æœªå‘½å';
      document.getElementById('presStrategySteps').textContent = q['ç­–ç•¥æ­¥é©Ÿ'] || 'ç„¡æ­¥é©Ÿè³‡æ–™';

      // é»é»å°è¦½
      const dots = document.getElementById('presDots');
      dots.innerHTML = '';
      for (let i = 0; i < total; i++) {
        const dot = document.createElement('button');
        dot.className = `w-2.5 h-2.5 rounded-full transition-all ${i === presIndex ? 'bg-blue-400 scale-125' : 'bg-slate-600 hover:bg-slate-400'}`;
        dot.onclick = () => { presIndex = i; renderPresQuestion(); };
        dots.appendChild(dot);
      }

      document.getElementById('presPrevBtn').disabled = presIndex === 0;
      document.getElementById('presNextBtn').disabled = presIndex === total - 1;
    }

    function navigatePresentation(dir) {
      const total = presArticle['é¡Œç›®åˆ—è¡¨'].length;
      presIndex = Math.max(0, Math.min(total - 1, presIndex + dir));
      renderPresQuestion();
    }

    function closePresentMode() {
      document.getElementById('presentModal').style.display = 'none';
      document.body.style.overflow = '';
      document.removeEventListener('keydown', handlePresKey);
      presArticle = null;
      // é—œé–‰æ™‚è‡ªå‹•åˆ‡å›å­¸ç”Ÿæ¨¡å¼
      document.body.classList.remove('teacher-mode');
      const btn = document.getElementById('modeToggleBtn');
      if (btn) { btn.textContent = 'ğŸ‘¨â€ğŸ« æ•™å¸«æ¨¡å¼'; btn.className = 'student px-3 py-1 rounded border text-xs font-bold transition'; }
    }

    function handlePresKey(e) {
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') navigatePresentation(1);
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') navigatePresentation(-1);
      if (e.key === 'Escape') closePresentMode();
    }

    // =============================================
    // æ•™å¸«/å­¸ç”Ÿæ¨¡å¼åˆ‡æ›
    // =============================================
    function toggleTeacherMode() {
      const isTeacher = document.body.classList.toggle('teacher-mode');
      const btn = document.getElementById('modeToggleBtn');
      if (isTeacher) {
        btn.textContent = 'ğŸ‘¨â€ğŸ‘¦ å­¸ç”Ÿæ¨¡å¼';
        btn.className = 'teacher px-3 py-1 rounded border text-xs font-bold transition';
      } else {
        btn.textContent = 'ğŸ‘¨â€ğŸ« æ•™å¸«æ¨¡å¼';
        btn.className = 'student px-3 py-1 rounded border text-xs font-bold transition';
      }
    }

    // =============================================
    // é¢æ¿é¡¯ç¤º/éš±è—åˆ‡æ›
    // =============================================
    function togglePanel(side) {
      const left = document.getElementById('presLeftPanel');
      const right = document.getElementById('presRightPanel');
      const divider = document.getElementById('presDivider');
      const btnLeft = document.getElementById('toggleLeft');
      const btnRight = document.getElementById('toggleRight');

      if (side === 'left') {
        const isCollapsed = left.classList.toggle('collapsed');
        btnLeft.classList.toggle('active', !isCollapsed);
        btnLeft.classList.toggle('inactive', isCollapsed);
        // è‹¥å…©å€‹éƒ½éš±è—ï¼Œè‡ªå‹•å±•é–‹å¦ä¸€é‚Š
        if (isCollapsed && right.classList.contains('collapsed')) {
          right.classList.remove('collapsed');
          btnRight.classList.add('active');
          btnRight.classList.remove('inactive');
        }
      } else {
        const isCollapsed = right.classList.toggle('collapsed');
        btnRight.classList.toggle('active', !isCollapsed);
        btnRight.classList.toggle('inactive', isCollapsed);
        if (isCollapsed && left.classList.contains('collapsed')) {
          left.classList.remove('collapsed');
  btnLeft.classList.add('active');
          btnLeft.classList.remove('inactive');
        }
      }

      // æ ¹æ“šé¡¯ç¤ºç‹€æ…‹èª¿æ•´å¯¬åº¦èˆ‡åˆ†éš”ç·š
      const leftHidden = left.classList.contains('collapsed');
      const rightHidden = right.classList.contains('collapsed');
      const bothVisible = !leftHidden && !rightHidden;

      divider.style.display = bothVisible ? '' : 'none';

      if (bothVisible) {
        // å…©é‚Šéƒ½é¡¯ç¤ºï¼šæ¢å¾©å„è‡ªçš„å¯¬åº¦
        left.style.flex = '';
        left.style.width = '41.67%';  // æ¢å¾©é è¨­å¯¬åº¦
        right.style.flex = '';
      } else if (leftHidden) {
        // åªé¡¯ç¤ºå³é‚Šï¼šå³é‚Šä½”æ»¿
        right.style.flex = '1';
      } else if (rightHidden) {
        // åªé¡¯ç¤ºå·¦é‚Šï¼šå·¦é‚Šä½”æ»¿
        left.style.flex = '1';
        left.style.width = '100%';
      }
    }


    // =============================================
    // æ‹–æ›³åˆ†éš”ç·š
    // =============================================
    function startDrag(e) {
      e.preventDefault();
      const divider = document.getElementById('presDivider');
      const leftPanel = document.getElementById('presLeftPanel');
      const contentArea = document.getElementById('presContentArea');
      divider.classList.add('dragging');

      function onMove(ev) {
        const rect = contentArea.getBoundingClientRect();
        let newLeftPct = ((ev.clientX - rect.left) / rect.width) * 100;
        newLeftPct = Math.max(15, Math.min(85, newLeftPct));
        leftPanel.style.width = newLeftPct + '%';
      }

      function onUp() {
        divider.classList.remove('dragging');
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    // =============================================
    // è¤‡è£½ç­–ç•¥æ–‡å­—
    // =============================================
    function copyStrategy(btn) {
      const text = btn.getAttribute('data-text');
      navigator.clipboard.writeText(text).then(() => { const original = btn.innerHTML;
        btn.innerHTML = 'âœ… å·²è¤‡è£½';
        btn.style.background = '#d1fae5';
        setTimeout(() => {
          btn.innerHTML = original;
          btn.style.background = '';
        }, 1500);
      }).catch(() => {
        // fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = text;
      document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.innerHTML = 'âœ… å·²è¤‡è£½';
        setTimeout(() => { btn.innerHTML = 'ğŸ“‹ è¤‡è£½'; }, 1500);
      });
    }

    // =============================================
    // é¦–æ¬¡ä½¿ç”¨èªªæ˜
    // =============================================
    function showOnboarding() {
      if (!localStorage.getItem('onboardingDone_v1')) {
        document.getElementById('onboardingOverlay').style.display = 'flex';
      }
    }

    function dismissOnboarding() {
      localStorage.setItem('onboardingDone_v1', '1');
      document.getElementById('onboardingOverlay').style.display = 'none';
    }

  </script>

  <!-- ====== é¦–æ¬¡ä½¿ç”¨èªªæ˜è¦†å±¤ ====== -->
  <div id="onboardingOverlay" style="display:none;">
    <div id="onboardingBox">
      <h2 style="font-size:1.3rem;font-weight:bold;color:#1e293b;margin-bottom:0.5rem;">ğŸ“š æ­¡è¿ä½¿ç”¨é–±è®€æ•™å­¸ç­–ç•¥è³‡æ–™åº«</h2>
      <p style="color:#64748b;font-size:0.85rem;margin-bottom:1.25rem;">é¦–æ¬¡ä½¿ç”¨ï¼Œå¿«é€Ÿèªªæ˜å¹¾å€‹é‡è¦åŠŸèƒ½ï¼š</p>

      <div class="onboard-tip">
        <div class="onboard-icon">ğŸ§ </div>
        <div><strong>èªçŸ¥æ­·ç¨‹ç¯©é¸</strong>ï¼šé¸æ“‡å¾Œï¼Œé»é–‹æ–‡ç« æ™‚ç›¸é—œé¡Œç›®æœƒè‡ªå‹•è—è‰²é«˜äº®é¡¯ç¤ºï¼Œæ–¹ä¾¿èšç„¦ã€‚</div>
      </div>
      <div class="onboard-tip">
        <div class="onboard-icon">ğŸ“º</div>
        <div><strong>ç°¡å ±æ¨¡å¼</strong>ï¼šæ¯å¼µå¡ç‰‡å³ä¸‹è§’çš„ç´«è‰² ğŸ“º æŒ‰éˆ•ï¼Œå¯é€²å…¥å…¨è¢å¹•æŠ•å½±æ©Ÿæ¨¡å¼ï¼Œé€é¡Œå¼•å°å­¸ç”Ÿã€‚</div>
      </div>
      <div class="onboard-tip">
        <div class="onboard-icon">ğŸ‘¨â€ğŸ«</div>
        <div><strong>æ•™å¸«/å­¸ç”Ÿæ¨¡å¼</strong>ï¼šç°¡å ±æ¨¡å¼å…§å¯åˆ‡æ›ï¼Œå­¸ç”Ÿæ¨¡å¼ä¸‹å­¸ç”Ÿè¿·æ€å’Œç­–ç•¥æœƒéš±è—ï¼Œé¿å…æ´©é¡Œã€‚</div>
      </div>
      <div class="onboard-tip">
        <div class="onboard-icon">ğŸ“‹</div>
        <div><strong>è¤‡è£½ç­–ç•¥</strong>ï¼šåœ¨æ–‡ç« è©³ç´°é ï¼Œæ»‘é¼ ç§»åˆ°ç¶ è‰²ç­–ç•¥å€å¡Šï¼Œå³ä¸Šè§’å‡ºç¾è¤‡è£½æŒ‰éˆ•ã€‚</div>
      </div>
      <div class="onboard-tip">
        <div class="onboard-icon">ğŸ–¨ï¸</div>
        <div><strong>åˆ—å°</strong>ï¼šè©³ç´°é å³ä¸Šè§’æœ‰åˆ—å°æŒ‰éˆ•ï¼Œå¯å°‡å…¨æ–‡ã€è©¦é¡Œã€ç­–ç•¥ä¸€æ¬¡å°å‡ºã€‚</div>
      </div>

      <button onclick="dismissOnboarding()"
        style="margin-top:1rem;width:100%;background:#3b82f6;color:white;font-weight:bold;padding:0.65rem 1rem;border-radius:0.75rem;border:none;cursor:pointer;font-size:1rem;">
        äº†è§£äº†ï¼Œé–‹å§‹ä½¿ç”¨ â†’
      </button>
    </div>
  </div>

</body>

</html>