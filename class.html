<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ‹èªå­—éŸ³å½¢ â€” èª²å ‚è¬›ç¾©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background: var(--gray-50); color: var(--gray-800); }

    /* â”€â”€ è¼‰å…¥ â”€â”€ */
    #loading {
      position: fixed; inset: 0; background: white;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 1000; gap: 14px;
    }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ é é¦– â”€â”€ */
    header {
      background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
      color: white; padding: 18px 32px;
    }
    header h1 { font-size: 1.4rem; font-weight: 700; }
    header p  { opacity: .8; font-size: .85rem; margin-top: 3px; }

    /* â”€â”€ ç¯©é¸åˆ— â”€â”€ */
    .filter-bar {
      background: white; border-bottom: 1px solid var(--gray-200);
      padding: 12px 32px; display: flex; flex-wrap: wrap;
      gap: 10px; align-items: center;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    .fg { display: flex; align-items: center; gap: 5px; }
    .fg label { font-size: .78rem; color: var(--gray-600); white-space: nowrap; font-weight: 500; }
    select {
      border: 1px solid var(--gray-200); border-radius: 8px;
      padding: 5px 9px; font-size: .85rem; color: var(--gray-700);
      background: var(--gray-50); outline: none; cursor: pointer;
    }
    select:focus { border-color: var(--primary); background: white; }

    /* â”€â”€ æ“ä½œåˆ— â”€â”€ */
    .action-bar {
      background: white; border-bottom: 1px solid var(--gray-200);
      padding: 10px 32px; display: flex; gap: 10px; align-items: center;
    }
    .btn {
      padding: 8px 20px; border-radius: 8px; font-size: .88rem;
      font-weight: 600; cursor: pointer; border: none;
      transition: background .15s, transform .1s;
      font-family: inherit;
    }
    .btn:active { transform: scale(.97); }
    .btn-proj   { background: #1e40af; color: white; }
    .btn-proj:hover { background: #1e3a8a; }
    .btn-print  { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-200); }
    .btn-print:hover { background: var(--gray-200); }
    .btn-reset  { background: none; color: var(--gray-600); border: 1px solid var(--gray-200); font-weight: 400; }
    .btn-reset:hover { background: var(--gray-100); }
    .cnt-info   { font-size: .85rem; color: var(--gray-600); margin-left: auto; }
    .cnt-info strong { color: var(--primary); }

    /* â”€â”€ ä¸»å…§å®¹ â”€â”€ */
    main { padding: 24px 32px 56px; max-width: 960px; margin: 0 auto; }

    /* â”€â”€ æ•™å­¸å–®å…ƒ â”€â”€ */
    .lesson-unit {
      background: white; border-radius: 14px;
      border: 2px solid var(--gray-200);
      margin-bottom: 28px; overflow: hidden;
      transition: border-color .15s, box-shadow .15s;
    }
    .lesson-unit.selected {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px #dbeafe;
    }

    /* å–®å…ƒæ¨™é ­ */
    .unit-head {
      padding: 14px 20px;
      background: linear-gradient(135deg, #eff6ff, #f5f3ff);
      border-bottom: 2px solid var(--gray-200);
      display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
    }
    .lesson-unit.selected .unit-head {
      background: linear-gradient(135deg, #dbeafe, #ede9fe);
    }
    .unit-title {
      width: 100%; font-size: 1.05rem; font-weight: 700;
      color: var(--gray-800); margin-top: 6px;
    }

    /* å‹¾é¸æ¡† */
    .unit-cb {
      width: 20px; height: 20px; cursor: pointer;
      accent-color: var(--primary); flex-shrink: 0;
      margin-right: 4px;
    }

    /* è€ƒå¤é¡Œæ¨¡å¼ï¼šéš±è—æ‰€æœ‰è¡¨æ ¼èˆ‡æ•™å­¸å…§å®¹ */
    body.kaoguti-mode .table-section { display: none; }
    body.kaoguti-mode .question-section {
      border-left: none; background: white; padding: 16px 20px;
    }
    body.kaoguti-mode .q-label { display: none; }
    body.kaoguti-mode .q-text  { font-size: 1rem; }

    /* å·²æ•™éç‹€æ…‹ */
    .lesson-unit.taught {
      border-color: #059669;
      box-shadow: 0 0 0 3px #d1fae5;
    }
    .lesson-unit.taught .unit-head {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    }
    .btn-taught-toggle {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 10px; border-radius: 20px;
      font-size: .74rem; font-weight: 600;
      cursor: pointer; border: 1px solid transparent;
      font-family: inherit; transition: background .15s;
      margin-left: auto;
    }
    .btn-taught-toggle.is-taught   { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    .btn-taught-toggle.not-taught  { background: var(--gray-100); color: var(--gray-600); border-color: var(--gray-200); }
    .btn-taught-toggle:hover { filter: brightness(.95); }

    /* å¾½ç«  */
    .badge {
      display: inline-flex; align-items: center;
      padding: 2px 9px; border-radius: 20px;
      font-size: .74rem; font-weight: 600;
    }
    .b-g3 { background: #dbeafe; color: #1e40af; }
    .b-g4 { background: #d1fae5; color: #065f46; }
    .b-g5 { background: #fef3c7; color: #92400e; }
    .b-g6 { background: #fce7f3; color: #9d174d; }
    .b-yr { background: var(--gray-100); color: var(--gray-600); }
    .b-ct { background: #ede9fe; color: #4c1d95; }
    .b-ez { background: #d1fae5; color: #065f46; }
    .b-md { background: #fef3c7; color: #92400e; }
    .b-hd { background: #fee2e2; color: #991b1b; }

    /* è¡¨æ ¼å€ */
    .table-section { padding: 20px; border-bottom: 2px dashed var(--gray-200); }
    .sec-label {
      font-size: .78rem; font-weight: 700; color: var(--gray-600);
      text-transform: uppercase; letter-spacing: .05em;
      margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
    }
    .sec-label::before {
      content: ''; display: block;
      width: 3px; height: 14px;
      background: var(--primary); border-radius: 2px;
    }
    .spacer { height: 18px; }

    /* æ¯”è¼ƒè¡¨ */
    .teach-tbl { width: 100%; border-collapse: collapse; font-size: .9rem; }
    .teach-tbl th {
      background: #1e40af; color: white;
      padding: 9px 13px; text-align: left; font-size: .82rem; font-weight: 600;
      print-color-adjust: exact; -webkit-print-color-adjust: exact;
    }
    .teach-tbl td {
      padding: 10px 13px; border-bottom: 1px solid var(--gray-200);
      vertical-align: top; line-height: 1.55;
    }
    .teach-tbl tr:last-child td { border-bottom: none; }
    .teach-tbl tr:nth-child(even) td { background: var(--gray-50); }
    .row-ok td { background: #f0fdf4 !important; }
    .row-err td { background: #fff1f2 !important; }
    .char-big  { font-size: 1.15rem; font-weight: 700; color: #1e40af; }
    .reading   { font-size: 1rem; color: #7c3aed; font-weight: 600; }

    /* é¡Œç›®å€ */
    .question-section {
      padding: 18px 20px;
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
    }
    .q-label {
      font-size: .8rem; font-weight: 700; color: #92400e;
      margin-bottom: 10px; display: flex; align-items: center; gap: 5px;
    }
    .q-text { font-size: .95rem; line-height: 1.85; white-space: pre-wrap; color: var(--gray-800); }

    /* â”€â”€ æ¸¬é©—æ¨¡å¼ â”€â”€ */
    .quiz-section { padding: 16px 20px; }
    .q-question {
      font-size: .95rem; line-height: 1.8; color: var(--gray-800);
      white-space: pre-wrap; margin-bottom: 14px;
    }
    .quiz-options { display: flex; flex-direction: column; gap: 8px; }
    .opt-btn {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 10px 14px; border: 2px solid var(--gray-200);
      border-radius: 8px; background: white; cursor: pointer;
      font-size: .9rem; text-align: left; font-family: inherit; width: 100%;
      transition: background .12s, border-color .12s;
    }
    .opt-btn:hover:not(:disabled) { background: #eff6ff; border-color: var(--primary); }
    .opt-btn.correct  { background: #f0fdf4 !important; border-color: #16a34a !important; color: #14532d; font-weight: 600; }
    .opt-btn.wrong    { background: #fff1f2 !important; border-color: #dc2626 !important; color: #7f1d1d; }
    .opt-btn.revealed { opacity: .55; }
    .opt-btn:disabled { cursor: default; }
    .opt-key { font-weight: 700; min-width: 22px; flex-shrink: 0; }
    .quiz-set-hint {
      margin-top: 10px; font-size: .78rem; color: #9ca3af;
      text-align: center; padding: 6px;
      border: 1px dashed #d1d5db; border-radius: 6px;
    }
    .quiz-score-bar {
      padding: 8px 20px; background: #eff6ff;
      border-top: 1px solid #bfdbfe;
      font-size: .82rem; color: #1e40af; display: flex; gap: 14px;
    }
    /* æ¸¬é©—æ¨¡å¼é–‹é—œæ™‚éš±è—ä¸éœ€è¦çš„å€å¡Š */
    body.quiz-mode .table-section  { display: none; }
    body.quiz-mode .question-section { display: none; }
    body.quiz-mode .ref-toggle     { display: none !important; }
    body.quiz-mode .ref-body       { display: none !important; }
    body.quiz-mode .quiz-section   { display: block; }
    /* éæ¸¬é©—æ¨¡å¼æ™‚éš±è—æ¸¬é©—å€å¡Š */
    .quiz-section { display: none; }

    /* æ¸¬é©—æ¨¡å¼æŒ‰éˆ•å¤–è§€ï¼ˆactive ç‹€æ…‹ï¼‰ */
    .btn-quiz-active { background: #dc2626 !important; color: white !important; }

    /* åˆ†æ•¸çµ±è¨ˆåˆ— */
    #scoreBar {
      display: none; position: sticky; top: 44px; z-index: 99;
      background: #1e40af; color: white;
      padding: 8px 32px; font-size: .88rem;
      display: none; align-items: center; gap: 20px;
    }
    #scoreBar.visible { display: flex; }

    /* å‚™èª²åƒè€ƒå€å¡Š */
    .ref-toggle {
      width: 100%; padding: 9px 20px;
      background: none; border: none; border-top: 1px solid var(--gray-200);
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; font-size: .82rem; color: #7c3aed; font-weight: 600;
      font-family: inherit; transition: background .12s;
    }
    .ref-toggle:hover { background: #faf5ff; }
    .ref-toggle .arrow { transition: transform .2s; display: inline-block; }
    .ref-toggle.open .arrow { transform: rotate(180deg); }

    .ref-body {
      display: none; padding: 14px 20px;
      border-top: 1px solid #ede9fe;
      background: #faf5ff;
      flex-direction: column; gap: 10px;
    }
    .ref-body.open { display: flex; }

    .ref-item { font-size: .85rem; line-height: 1.6; }
    .ref-lbl {
      font-size: .75rem; font-weight: 700; color: #7c3aed;
      margin-bottom: 4px; display: flex; align-items: center; gap: 4px;
    }
    .box-y { background:#fffbeb; border-left:3px solid #f59e0b; padding:7px 10px; border-radius:0 6px 6px 0; }
    .box-g { background:#f0fdf4; border-left:3px solid #22c55e; padding:7px 10px; border-radius:0 6px 6px 0; }
    .box-b { background:#eff6ff; border-left:3px solid #3b82f6; padding:7px 10px; border-radius:0 6px 6px 0; }

    /* è€ƒå¤é¡Œæ¨¡å¼ä¸‹éš±è—å‚™èª²åƒè€ƒ */
    body.kaoguti-mode .ref-toggle,
    body.kaoguti-mode .ref-body { display: none; }

    /* ç©ºçµæœ */
    .empty { text-align: center; padding: 60px; color: var(--gray-600); }

    /* â•â•â•â•â•â•â•â• æŠ•å½±æ¨¡å¼ â•â•â•â•â•â•â•â• */
    #projector {
      display: none; position: fixed; inset: 0;
      background: #0f172a; color: white;
      flex-direction: column; z-index: 9999;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    #projector.active { display: flex; }

    .proj-topbar {
      background: #1e293b; padding: 12px 28px;
      display: flex; align-items: center; gap: 12px; flex-shrink: 0;
      border-bottom: 1px solid #334155;
    }
    .proj-badges { display: flex; gap: 7px; }
    .proj-title  { font-size: 1.05rem; font-weight: 700; flex: 1; }
    .proj-counter{ font-size: .9rem; color: #94a3b8; white-space: nowrap; }
    .btn-exit {
      padding: 6px 14px; border-radius: 6px;
      background: #374151; color: #e2e8f0; border: none;
      cursor: pointer; font-size: .85rem; font-family: inherit;
    }
    .btn-exit:hover { background: #4b5563; }

    .proj-content {
      flex: 1; overflow-y: auto;
      padding: 28px 48px;
      display: flex; flex-direction: column; gap: 28px;
    }
    .proj-sec-label {
      font-size: .82rem; color: #94a3b8; font-weight: 600;
      text-transform: uppercase; letter-spacing: .06em;
      margin-bottom: 10px;
    }

    .proj-tbl { width: 100%; border-collapse: collapse; font-size: 1.25rem; }
    .proj-tbl th {
      background: #1d4ed8; color: white;
      padding: 11px 16px; text-align: left; font-size: .95rem;
      print-color-adjust: exact; -webkit-print-color-adjust: exact;
    }
    .proj-tbl td {
      padding: 13px 16px; border-bottom: 1px solid #1e293b;
      vertical-align: middle; line-height: 1.5;
    }
    .proj-tbl tr:last-child td { border-bottom: none; }
    .proj-tbl tr:nth-child(even) td { background: #1e293b; }
    .proj-row-ok  td { background: #14532d !important; }
    .proj-row-err td { background: #450a0a !important; }
    .proj-char    { font-size: 1.5rem; font-weight: 700; color: #60a5fa; }
    .proj-reading { font-size: 1.3rem; color: #a78bfa; font-weight: 700; }

    .proj-question {
      background: #1e293b; border-radius: 12px;
      border-left: 5px solid #f59e0b;
      padding: 22px 28px;
    }
    .proj-question.hidden { display: none; }
    .proj-q-label { font-size: .85rem; color: #fbbf24; font-weight: 700; margin-bottom: 12px; }
    .proj-q-text  { font-size: 1.25rem; line-height: 2; white-space: pre-wrap; color: #f1f5f9; }

    /* é€²åº¦æ¢ */
    .proj-progress-bar {
      height: 3px; background: #1e293b; flex-shrink: 0;
    }
    .proj-progress-fill {
      height: 100%; background: #3b82f6;
      transition: width .3s ease;
    }

    .proj-nav {
      background: #1e293b; padding: 14px 28px;
      display: flex; align-items: center; justify-content: center;
      gap: 14px; flex-shrink: 0;
    }
    .btn-nav {
      padding: 10px 28px; border-radius: 8px;
      background: #374151; color: white; border: none;
      cursor: pointer; font-size: .95rem; font-weight: 600; font-family: inherit;
    }
    .btn-nav:hover:not(:disabled) { background: #4b5563; }
    .btn-nav:disabled { opacity: .3; cursor: not-allowed; }
    .btn-reveal {
      padding: 10px 28px; border-radius: 8px;
      background: #d97706; color: white; border: none;
      cursor: pointer; font-size: .95rem; font-weight: 600; font-family: inherit;
    }
    .btn-reveal:hover { background: #b45309; }
    .proj-hint {
      font-size: .75rem; color: #475569;
      text-align: center; padding: 0 28px 10px;
      flex-shrink: 0;
    }

    /* â”€â”€ åˆ—å°æ¨£å¼ â”€â”€ */
    @media print {
      #loading, .filter-bar, .action-bar, #projector { display: none !important; }
      header { padding: 12px 20px; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      body { background: white; }
      main { padding: 12px 0 0; max-width: 100%; }
      .lesson-unit {
        border: 1px solid #ccc; border-radius: 8px;
        margin-bottom: 16px; page-break-inside: avoid; break-inside: avoid;
      }
      .unit-head { background: #f0f4ff !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .teach-tbl th { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .row-ok td { background: #f0fdf4 !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .row-err td { background: #fff1f2 !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .question-section { background: #fffbeb !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    }

    @media (max-width: 700px) {
      header, .filter-bar, .action-bar { padding: 12px 16px; }
      main { padding: 16px 14px 40px; }
      .proj-content { padding: 16px 18px; }
      .proj-tbl, .proj-q-text { font-size: 1rem; }
    }
  </style>
</head>
<body>

<!-- è¼‰å…¥ç•«é¢ -->
<div id="loading">
  <div class="spinner"></div>
  <div style="font-size:1rem;font-weight:600;color:#374151">æ­£åœ¨è¼‰å…¥æ•™å­¸è³‡æ–™åº«â€¦</div>
  <div style="font-size:.85rem;color:#9ca3af">åªè¼‰å…¥æœ‰ç´°ç›®è³‡æ–™çš„é¡Œç›®</div>
</div>

<!-- é é¦– -->
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
    <div>
      <h1>ğŸ“ åœ‹èªå­—éŸ³å½¢ â€” èª²å ‚è¬›ç¾©</h1>
      <p>å­—éŸ³å½¢æ¯”è¼ƒè¡¨ç‚ºä¸» Â· æ­é…è€ƒé¡Œ Â· æ”¯æ´æŠ•å½± / åˆ—å°</p>
    </div>
    <a href="å‚™èª²æœå°‹å¼•æ“.html"
       style="display:inline-block;padding:8px 18px;background:rgba(255,255,255,.2);
              color:white;border-radius:8px;text-decoration:none;font-size:.88rem;
              font-weight:600;border:1px solid rgba(255,255,255,.4);white-space:nowrap"
       onmouseover="this.style.background='rgba(255,255,255,.35)'"
       onmouseout="this.style.background='rgba(255,255,255,.2)'">
      ğŸ“š åˆ‡æ›åˆ°å‚™èª²æœå°‹å¼•æ“ â†’
    </a>
  </div>
</header>

<!-- ç¯©é¸åˆ— -->
<div class="filter-bar">
  <div class="fg">
    <label>å¹´ç´š</label>
    <select id="fGrade"><option value="">å…¨éƒ¨å¹´ç´š</option></select>
  </div>
  <div class="fg">
    <label>å¹´åº¦</label>
    <select id="fYear"><option value="">å…¨éƒ¨å¹´åº¦</option></select>
  </div>
  <div class="fg">
    <label>é¡åˆ¥</label>
    <select id="fCat"><option value="">å…¨éƒ¨é¡åˆ¥</option></select>
  </div>
  <div class="fg">
    <label>é›£æ˜“åº¦</label>
    <select id="fDiff">
      <option value="">å…¨éƒ¨</option>
      <option value="åŸºç¤">åŸºç¤</option>
      <option value="ä¸­éš">ä¸­éš</option>
      <option value="é€²éš">é€²éš</option>
    </select>
  </div>
  <div class="fg">
    <label>æ•™å­¸é€²åº¦</label>
    <select id="fTaught">
      <option value="">å…¨éƒ¨</option>
      <option value="0">æœªæ•™é</option>
      <option value="1">å·²æ•™é</option>
    </select>
  </div>
  <div class="fg">
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer">
      <input type="checkbox" id="fKaoguti" onchange="applyFilter()"
             style="width:16px;height:16px;accent-color:#2563eb;cursor:pointer">
      åªé¡¯ç¤ºè€ƒå¤é¡Œ
    </label>
  </div>
  <button class="btn btn-reset" onclick="reset()">æ¸…é™¤æ¢ä»¶</button>
</div>

<!-- åˆ†æ•¸çµ±è¨ˆåˆ— -->
<div id="scoreBar">
  <span>ğŸ¯ æ¸¬é©—æ¨¡å¼</span>
  <span>ç­”å° <strong id="scoreRight">0</strong> é¡Œ</span>
  <span>ç­”éŒ¯ <strong id="scoreWrong">0</strong> é¡Œ</span>
  <span id="scoreTotal" style="opacity:.7"></span>
  <button onclick="resetQuizScore()" style="margin-left:auto;padding:4px 12px;border-radius:6px;background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.4);cursor:pointer;font-family:inherit;font-size:.82rem">é‡ç½®åˆ†æ•¸</button>
</div>

<!-- æ“ä½œåˆ— -->
<div class="action-bar">
  <button class="btn btn-proj"   onclick="enterProjector()">â–¶ æŠ•å½±æ¨¡å¼</button>
  <button class="btn btn-print"  id="btnQuiz" onclick="toggleQuizMode()" style="background:#7c3aed;color:white">ğŸ“ æ¸¬é©—æ¨¡å¼</button>
  <button class="btn btn-print"  onclick="window.print()">ğŸ–¨ï¸ åˆ—å°è¬›ç¾©</button>
  <button class="btn btn-reset"  onclick="selectAll()">å…¨é¸</button>
  <button class="btn btn-reset"  onclick="selectNone()">å–æ¶ˆå…¨é¸</button>
  <button class="btn btn-reset"  onclick="clearTaught()" title="æ¸…é™¤æ‰€æœ‰å·²æ•™éçš„è¨˜éŒ„">ğŸ—‘ï¸ æ¸…é™¤æ•™å­¸è¨˜éŒ„</button>
  <span class="cnt-info" id="selInfo" style="display:none">
    å·²å‹¾é¸ <strong id="selCnt" style="color:#2563eb">0</strong> é¡Œï¼ˆæŠ•å½±å°‡åªæ’­å‹¾é¸çš„ï¼‰
  </span>
  <span class="cnt-info" id="totalInfo">
    å…± <strong id="cnt">0</strong> é“é¡Œç›®
    <span id="kaogutiNote" style="display:none;color:#059669;font-size:.8rem">ï¼ˆè€ƒå¤é¡Œæ¨¡å¼ï¼‰</span>
  </span>
</div>

<!-- ä¸»åˆ—è¡¨ -->
<main><div id="grid"></div></main>

<!-- æŠ•å½±æ¨¡å¼ï¼ˆå…¨è¢å¹•è¦†è“‹ï¼‰ -->
<div id="projector">
  <div class="proj-topbar">
    <div class="proj-badges" id="projBadges"></div>
    <div class="proj-title"  id="projTitle"></div>
    <div class="proj-counter" id="projCounter"></div>
    <button class="btn-exit" onclick="exitProjector()">âœ• é›¢é–‹</button>
  </div>
  <div class="proj-progress-bar"><div class="proj-progress-fill" id="projProgress"></div></div>
  <div class="proj-content" id="projContent"></div>
  <div class="proj-nav">
    <button class="btn-nav" id="btnPrev" onclick="prevSlide()">â† ä¸Šä¸€é¡Œ</button>
    <button class="btn-reveal" id="btnReveal" onclick="revealQuestion()">ğŸ“ é¡¯ç¤ºé¡Œç›®</button>
    <button class="btn-nav" id="btnTaught" onclick="markTaughtInProjector()"
            style="background:#047857;color:white;min-width:110px">â—‹ æ¨™è¨˜å·²æ•™</button>
    <button class="btn-nav" id="btnNext" onclick="nextSlide()">ä¸‹ä¸€é¡Œ â†’</button>
  </div>
  <div class="proj-hint">â† â†’ åˆ‡æ›é¡Œç›® &nbsp;|&nbsp; ç©ºç™½éµ é¡¯ç¤ºé¡Œç›® / ä¸‹ä¸€é¡Œ &nbsp;|&nbsp; T æ¨™è¨˜å·²æ•™ &nbsp;|&nbsp; Esc é›¢é–‹</div>
</div>

<script>
/* â•â•â• è¨­å®š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHEET_ID = '1MoZ0VhgJ9fSWktZUjunX1IMJwDuFBP_qyZFuEnH6uGo';
const TABS = { q:'é¡Œç›®ä¸»è¡¨', m:'æ•™æè³‡æ–™åº«', py:'ç ´éŸ³å­—ç´°ç›®', cz:'éŒ¯åˆ¥å­—ç´°ç›®', xj:'å½¢è¿‘å­—ç´°ç›®' };
const csvUrl = name =>
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;

/* â•â•â• å…¨åŸŸè³‡æ–™ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ALL = [], SHOWN = [];
let projData = [], projIdx = 0, projRevealed = false;

/* â•â•â• æ•™å­¸è¨˜æ†¶ï¼ˆlocalStorageï¼‰â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORAGE_KEY = 'taught_questions_v1';
let TAUGHT = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

function saveTaught() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...TAUGHT]));
}

function toggleTaught(uid) {
  if (TAUGHT.has(uid)) TAUGHT.delete(uid); else TAUGHT.add(uid);
  saveTaught();
  // ç›´æ¥æ›´æ–°å¡ç‰‡ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
  const unit = document.getElementById('unit-' + uid);
  if (!unit) return;
  const isTaught = TAUGHT.has(uid);
  unit.classList.toggle('taught', isTaught);
  const btn = unit.querySelector('.btn-taught-toggle');
  if (btn) {
    btn.textContent = isTaught ? 'âœ… å·²æ•™é' : 'â—‹ æœªæ•™é';
    btn.className = `btn-taught-toggle ${isTaught ? 'is-taught' : 'not-taught'}`;
  }
}

function clearTaught() {
  if (!confirm(`ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ•™å­¸è¨˜éŒ„ï¼Ÿ\nï¼ˆç›®å‰å·²è¨˜éŒ„ ${TAUGHT.size} é“é¡Œç›®ï¼‰`)) return;
  TAUGHT.clear();
  saveTaught();
  renderList();
}

function markTaughtInProjector() {
  const q = projData[projIdx];
  const uid = q['é¡Œç›®ID'] || q['é¡Œè™Ÿ'];
  TAUGHT.add(uid);
  saveTaught();
  // æ›´æ–°æŠ•å½±æŒ‰éˆ•
  const btn = $('btnTaught');
  btn.textContent = 'âœ… å·²æ•™é';
  btn.style.background = '#059669';
  // åŒæ­¥æ›´æ–°åˆ—è¡¨å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const unit = document.getElementById('unit-' + uid);
  if (unit) {
    unit.classList.add('taught');
    const tb = unit.querySelector('.btn-taught-toggle');
    if (tb) { tb.textContent = 'âœ… å·²æ•™é'; tb.className = 'btn-taught-toggle is-taught'; }
  }
}

/* â•â•â• å·¥å…· â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const gradeClass = g => ({'ä¸‰å¹´ç´š':'b-g3','å››å¹´ç´š':'b-g4','äº”å¹´ç´š':'b-g5','å…­å¹´ç´š':'b-g6'}[g]||'b-yr');
const diffClass  = d => ({'åŸºç¤':'b-ez','ä¸­éš':'b-md','é€²éš':'b-hd'}[d]||'b-yr');

function fetch_csv(name) {
  return new Promise((ok, err) =>
    Papa.parse(csvUrl(name), { download:true, header:true, skipEmptyLines:true, complete:r=>ok(r.data), error:e=>err(e) })
  );
}

/* â•â•â• è¼‰å…¥ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  try {
    const [q, m, py, cz, xj] = await Promise.all([
      fetch_csv(TABS.q), fetch_csv(TABS.m),
      fetch_csv(TABS.py), fetch_csv(TABS.cz), fetch_csv(TABS.xj),
    ]);

    const matMap = {};
    m.forEach(r => matMap[r['æ•™æç·¨è™Ÿ']] = r);

    const pyMap = {}, czMap = {}, xjMap = {};
    py.forEach(r => { (pyMap[r['é¡Œç›®ID']] || (pyMap[r['é¡Œç›®ID']] = [])).push(r); });
    cz.forEach(r => { (czMap[r['é¡Œç›®ID']] || (czMap[r['é¡Œç›®ID']] = [])).push(r); });
    xj.forEach(r => { (xjMap[r['é¡Œç›®ID']] || (xjMap[r['é¡Œç›®ID']] = [])).push(r); });

    ALL = q.map(row => ({
      ...row,
      _mat: matMap[row['å°æ‡‰æ•™æç·¨è™Ÿ']] || null,
      _py:  pyMap[row['é¡Œç›®ID']] || [],
      _cz:  czMap[row['é¡Œç›®ID']] || [],
      _xj:  xjMap[row['é¡Œç›®ID']] || [],
    }));

    fillSelects();
    applyFilter();
    $('loading').style.display = 'none';
  } catch(e) {
    $('loading').innerHTML = `
      <div style="text-align:center;padding:40px">
        <div style="font-size:2.5rem">âš ï¸</div>
        <div style="font-size:1rem;font-weight:600;margin-top:10px">è³‡æ–™è¼‰å…¥å¤±æ•—</div>
        <div style="font-size:.85rem;color:#6b7280;margin-top:8px">è«‹ç¢ºèª Google Sheets å·²è¨­ç‚ºå…¬é–‹</div>
        <div style="font-size:.75rem;color:#9ca3af;margin-top:6px">${esc(String(e))}</div>
      </div>`;
  }
}

/* â•â•â• å¡«å……é¸å–® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fillSelects() {
  const uniq = (arr, key) => [...new Set(arr.map(d=>d[key]).filter(Boolean))];
  uniq(ALL,'å¹´ç´š').sort()
    .forEach(v => $('fGrade').innerHTML += `<option value="${esc(v)}">${esc(v)}</option>`);
  uniq(ALL,'å¹´åº¦').sort((a,b)=>b-a)
    .forEach(v => $('fYear').innerHTML += `<option value="${esc(v)}">${esc(v)} å¹´åº¦</option>`);
  uniq(ALL,'é¡åˆ¥').sort()
    .forEach(v => $('fCat').innerHTML += `<option value="${esc(v)}">${esc(v)}</option>`);
}

/* â•â•â• ç¯©é¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyFilter() {
  const grade   = $('fGrade').value,  year   = $('fYear').value;
  const cat     = $('fCat').value,    diff   = $('fDiff').value;
  const tFilter  = $('fTaught').value;        // '' | '0' | '1'
  const kaogutiOnly = $('fKaoguti').checked; // åªé¡¯ç¤ºæœ‰å®Œæ•´é¡Œç›®çš„è€ƒå¤é¡Œ

  SHOWN = ALL.filter(q => {
    if (grade && q['å¹´ç´š']       !== grade) return false;
    if (year  && q['å¹´åº¦']       !== year)  return false;
    if (cat   && q['é¡åˆ¥']       !== cat)   return false;
    if (diff  && q['é›£æ˜“åº¦åˆ†ç´š'] !== diff)  return false;
    if (kaogutiOnly && !q['å®Œæ•´é¡Œç›®èˆ‡é¸é …']) return false;
    const uid = q['é¡Œç›®ID'] || q['é¡Œè™Ÿ'];
    if (tFilter === '0' &&  TAUGHT.has(uid)) return false;
    if (tFilter === '1' && !TAUGHT.has(uid)) return false;
    return true;
  });
  $('cnt').textContent = SHOWN.length;
  $('kaogutiNote').style.display = kaogutiOnly ? '' : 'none';
  document.body.classList.toggle('kaoguti-mode', kaogutiOnly);
  renderList();
}

function reset() {
  ['fGrade','fYear','fCat','fDiff','fTaught'].forEach(id => $(id).value = '');
  $('fKaoguti').checked = false;
  applyFilter();
}

/* â•â•â• åˆ—è¡¨æ¸²æŸ“ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderList() {
  const grid = $('grid');
  if (!SHOWN.length) {
    grid.innerHTML = '<div class="empty">ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶</div>';
    return;
  }
  grid.innerHTML = SHOWN.map(q => unitHtml(q)).join('');
}

function unitHtml(q) {
  const uid      = q['é¡Œç›®ID'] || q['é¡Œè™Ÿ'];
  const isTaught = TAUGHT.has(uid);
  const badges = `
    <span class="badge ${gradeClass(q['å¹´ç´š'])}">${esc(q['å¹´ç´š'])}</span>
    <span class="badge b-yr">${esc(q['å¹´åº¦'])} å¹´</span>
    <span class="badge b-yr">ç¬¬ ${esc(q['é¡Œè™Ÿ'])} é¡Œ</span>
    ${q['é¡åˆ¥']       ? `<span class="badge b-ct">${esc(q['é¡åˆ¥'])}</span>`                     : ''}
    ${q['é›£æ˜“åº¦åˆ†ç´š'] ? `<span class="badge ${diffClass(q['é›£æ˜“åº¦åˆ†ç´š'])}">${esc(q['é›£æ˜“åº¦åˆ†ç´š'])}</span>` : ''}`;

  const qText = q['å®Œæ•´é¡Œç›®èˆ‡é¸é …'] || '';

  return `
<div class="lesson-unit${isTaught ? ' taught' : ''}" id="unit-${esc(uid)}">
  <div class="unit-head">
    <input type="checkbox" class="unit-cb" data-id="${esc(uid)}" onchange="onCheck(this)">
    ${badges}
    <button class="btn-taught-toggle ${isTaught ? 'is-taught' : 'not-taught'}"
            onclick="toggleTaught('${esc(uid)}')" title="é»æ“Šåˆ‡æ›æ•™å­¸ç‹€æ…‹">
      ${isTaught ? 'âœ… å·²æ•™é' : 'â—‹ æœªæ•™é'}
    </button>
    <div class="unit-title">${esc(q['é¡Œç›®é‡é»'])}</div>
  </div>
  <div class="table-section">
    ${buildListTables(q)}
  </div>
  ${qText ? `
  <div class="question-section">
    <div class="q-label">ğŸ“ é¡Œç›®èˆ‡é¸é …</div>
    <div class="q-text">${esc(qText)}</div>
  </div>` : ''}
  ${buildQuizSection(q, uid)}
  ${buildRefSection(q, uid)}
</div>`;
}

/* â•â•â• æ¸¬é©—æ¨¡å¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ANS_KEY = 'question_answers_v1';
let ANSWERS = JSON.parse(localStorage.getItem(ANS_KEY) || '{}');
let quizActive = false;
let qRight = 0, qWrong = 0;

function saveAnswers() { localStorage.setItem(ANS_KEY, JSON.stringify(ANSWERS)); }

/* è§£æé¡Œç›®é¸é … (1)(2)(3)(4) */
function parseOptions(text) {
  if (!text) return null;
  const re = /[ï¼ˆ(]([1-4ï¼‘-ï¼”])[)ï¼‰]\s*([^(ï¼ˆï¼‰)]+?)(?=[ï¼ˆ(][1-4ï¼‘-ï¼”][)ï¼‰]|$)/g;
  const opts = [...text.matchAll(re)].map(m => ({
    key: m[1].replace(/[ï¼‘ï¼’ï¼“ï¼”]/g, c => 'ï¼‘ï¼’ï¼“ï¼”'.indexOf(c) + 1),
    text: m[2].trim()
  }));
  return opts.length >= 2 ? opts : null;
}

/* è‡ªå‹•æ¨ç®—ï¼šç ´éŸ³å­— â€” æ³¨éŸ³ç‚ºå°‘æ•¸çš„é‚£å€‹é¸é … */
function deriveAnswerPY(q) {
  if (!q._py.length) return null;
  const map = {};
  for (const r of q._py) {
    const m = r['ä¾†æº'].match(/é¸é …\((\d)\)/);
    if (m) map[m[1]] = r['æ³¨éŸ³'];
  }
  const freq = {};
  for (const v of Object.values(map)) freq[v] = (freq[v]||0) + 1;
  const odd = Object.entries(freq).find(([,c]) => c === 1)?.[0];
  if (!odd) return null;
  return Object.entries(map).find(([,v]) => v === odd)?.[0] || null;
}

/* è‡ªå‹•æ¨ç®—ï¼šéŒ¯åˆ¥å­— â€” âœ“ æ­£ç¢ºé‚£è¡Œå°æ‡‰çš„é¸é … */
function deriveAnswerCZ(q) {
  const correctRow = q._cz.find(r => (r['æ­£èª¤']||'').includes('âœ“'));
  if (!correctRow) return null;
  const opts = parseOptions(q['å®Œæ•´é¡Œç›®èˆ‡é¸é …']);
  if (!opts) return null;
  const bracket = (correctRow['éŒ¯èª¤å¯«æ³•']||'').match(/ã€(.+?)ã€‘/);
  if (!bracket) return null;
  const char = bracket[1];
  const found = opts.find(o => o.text.includes(`ã€${char}ã€‘`) || o.text.includes(`ã€Œ${char}ã€`));
  return found ? String(found.key) : null;
}

function getAnswer(q) {
  const uid = q['é¡Œç›®ID'] || q['é¡Œè™Ÿ'];
  if (ANSWERS[uid] != null) return String(ANSWERS[uid]);
  if (q._cz.length) return deriveAnswerCZ(q);
  if (q._py.length) return deriveAnswerPY(q);
  return null;
}

/* æ¸¬é©—å€å¡Š HTML */
function buildQuizSection(q, uid) {
  const qText = q['å®Œæ•´é¡Œç›®èˆ‡é¸é …'];
  if (!qText) return '';
  const opts = parseOptions(qText);
  const qPart = opts
    ? qText.substring(0, qText.search(/[ï¼ˆ(][1-4ï¼‘-ï¼”][)ï¼‰]/)).trim()
    : qText;
  const answer = getAnswer(q);
  const hasAnswer = answer != null;

  const optButtons = opts ? opts.map(o => `
    <button class="opt-btn" data-key="${o.key}"
            onclick="selectOpt(this,'${esc(uid)}','${o.key}')">
      <span class="opt-key">(${o.key})</span>
      <span>${esc(o.text)}</span>
    </button>`).join('') : '';

  const hint = !hasAnswer ? `
    <div class="quiz-set-hint">âš ï¸ å°šæœªè¨­å®šç­”æ¡ˆ â€” é»é¸æ­£ç¢ºé¸é …å³å¯å„²å­˜</div>` : '';

  return `
<div class="quiz-section" id="quiz-${esc(uid)}">
  <div class="q-question">${esc(qPart)}</div>
  ${opts ? `<div class="quiz-options" id="opts-${esc(uid)}">${optButtons}</div>${hint}` :
           `<div style="font-size:.9rem;color:#6b7280;padding:4px 0">ï¼ˆç„¡æ³•è§£æé¸é …æ ¼å¼ï¼‰</div>`}
</div>`;
}

/* é»é¸é¸é … */
function selectOpt(btn, uid, key) {
  const container = document.getElementById('opts-' + uid);
  if (!container) return;
  const btns = container.querySelectorAll('.opt-btn');
  const answer = ANSWERS[uid] != null ? String(ANSWERS[uid]) : null;

  if (answer == null) {
    // è€å¸«è¨­å®šç­”æ¡ˆæ¨¡å¼
    if (!confirm(`è¨­å®š (${key}) ç‚ºæ­£ç¢ºç­”æ¡ˆï¼Ÿ`)) return;
    ANSWERS[uid] = key;
    saveAnswers();
    btns.forEach(b => b.classList.add('revealed'));
    btn.classList.remove('revealed');
    btn.classList.add('correct');
    document.querySelector(`#quiz-${uid} .quiz-set-hint`)?.remove();
    return;
  }

  // å­¸ç”Ÿä½œç­”æ¨¡å¼
  btns.forEach(b => {
    b.disabled = true;
    b.classList.add('revealed');
    if (String(b.dataset.key) === answer) b.classList.add('correct');
  });
  const isRight = String(key) === answer;
  if (!isRight) btn.classList.add('wrong');

  // è¨ˆåˆ†
  if (isRight) { qRight++; } else { qWrong++; }
  updateScore();
}

/* åˆ‡æ›æ¸¬é©—æ¨¡å¼ */
function toggleQuizMode() {
  quizActive = !quizActive;
  document.body.classList.toggle('quiz-mode', quizActive);
  const btn = $('btnQuiz');
  btn.textContent = quizActive ? 'âœ• çµæŸæ¸¬é©—' : 'ğŸ“ æ¸¬é©—æ¨¡å¼';
  btn.style.background = quizActive ? '#dc2626' : '#7c3aed';
  $('scoreBar').classList.toggle('visible', quizActive);
  if (quizActive) { qRight = 0; qWrong = 0; updateScore(); resetOptButtons(); }
}

function resetOptButtons() {
  document.querySelectorAll('.opt-btn').forEach(b => {
    b.disabled = false;
    b.classList.remove('correct','wrong','revealed');
  });
}

function updateScore() {
  $('scoreRight').textContent = qRight;
  $('scoreWrong').textContent = qWrong;
  const total = qRight + qWrong;
  $('scoreTotal').textContent = total ? `æ­£ç¢ºç‡ ${Math.round(qRight/total*100)}%` : '';
}

function resetQuizScore() {
  qRight = 0; qWrong = 0;
  updateScore();
  resetOptButtons();
}

/* å‚™èª²åƒè€ƒå€å¡Š */
function buildRefSection(q, uid) {
  const items = [
    ['ğŸ’¡ å­¸ç”Ÿå¸¸è¦‹è¿·æ€', q['å­¸ç”Ÿè¿·æ€'],     'box-y'],
    ['ğŸ¯ æ•™å­¸ç­–ç•¥',     q['æ•™å­¸ç­–ç•¥'],     'box-g'],
    ['ğŸ§  è¨˜æ†¶è¨£ç«…',     q['è¨˜æ†¶è¨£ç«…'],     'box-b'],
    ['ğŸ”¤ è®€éŸ³å€åˆ†',     q['è®€éŸ³å€åˆ†æ‘˜è¦'], 'box-b'],
  ].filter(([, v]) => v && v.trim());

  if (!items.length) return '';

  const inner = items.map(([lbl, val, cls]) => `
    <div class="ref-item">
      <div class="ref-lbl">${lbl}</div>
      <div class="${cls}">${esc(val)}</div>
    </div>`).join('');

  return `
  <button class="ref-toggle" onclick="toggleRef('ref-${esc(uid)}', this)">
    <span>ğŸ“– å‚™èª²åƒè€ƒï¼ˆè¿·æ€ãƒ»ç­–ç•¥ãƒ»è¨£ç«…ï¼‰</span>
    <span class="arrow">â–¼</span>
  </button>
  <div class="ref-body" id="ref-${esc(uid)}">${inner}</div>`;
}

function toggleRef(id, btn) {
  const el = document.getElementById(id);
  if (!el) return;
  const open = el.classList.toggle('open');
  btn.classList.toggle('open', open);
}

/* åˆ—è¡¨ç‰ˆæ¯”è¼ƒè¡¨ */
function buildListTables(q) {
  const parts = [];

  if (q._py.length) parts.push(`
    <div class="sec-label">ç ´éŸ³å­—æ¯”è¼ƒ</div>
    <table class="teach-tbl">
      <thead><tr><th>ä¾†æº</th><th>ç ´éŸ³å­—</th><th>è©èª</th><th>æ³¨éŸ³</th><th>å­—ç¾©èªªæ˜</th></tr></thead>
      <tbody>${q._py.map(r => `
        <tr>
          <td>${esc(r['ä¾†æº'])}</td>
          <td class="char-big">${esc(r['ç ´éŸ³å­—'])}</td>
          <td>${esc(r['è©èª'])}</td>
          <td class="reading">${esc(r['æ³¨éŸ³'])}</td>
          <td>${esc(r['å­—ç¾©èªªæ˜'])}</td>
        </tr>`).join('')}
      </tbody>
    </table>`);

  if (q._cz.length) parts.push(`
    <div class="sec-label">éŒ¯åˆ¥å­—è¾¨æ</div>
    <table class="teach-tbl">
      <thead><tr><th>æ­£èª¤</th><th>å¥ä¸­å¯«æ³•</th><th>æ­£ç¢ºè©èª</th><th>å­—ç¾©èªªæ˜</th></tr></thead>
      <tbody>${q._cz.map(r => `
        <tr class="${(r['æ­£èª¤']||'').includes('âœ“') ? 'row-ok' : 'row-err'}">
          <td><strong>${esc(r['æ­£èª¤'])}</strong></td>
          <td>${esc(r['éŒ¯èª¤å¯«æ³•'])}</td>
          <td>${esc(r['æ­£ç¢ºè©èª'])}</td>
          <td>${esc(r['å­—ç¾©èªªæ˜'])}</td>
        </tr>`).join('')}
      </tbody>
    </table>`);

  if (q._xj.length) parts.push(`
    <div class="sec-label">å½¢è¿‘å­— / åŒéŸ³å­—è¾¨æ</div>
    <table class="teach-tbl">
      <thead><tr><th>å­—</th><th>èªè©</th><th>è§£é‡‹</th></tr></thead>
      <tbody>${q._xj.map(r => `
        <tr>
          <td class="char-big">${esc(r['å­—'])}</td>
          <td>${esc(r['èªè©'])}</td>
          <td>${esc(r['è§£é‡‹'])}</td>
        </tr>`).join('')}
      </tbody>
    </table>`);

  return parts.join('<div class="spacer"></div>');
}

/* â•â•â• å‹¾é¸æ§åˆ¶ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onCheck(cb) {
  const unit = document.getElementById('unit-' + cb.dataset.id);
  if (unit) unit.classList.toggle('selected', cb.checked);
  updateSelCount();
}

function updateSelCount() {
  const checked = document.querySelectorAll('.unit-cb:checked').length;
  $('selCnt').textContent = checked;
  $('selInfo').style.display   = checked > 0 ? '' : 'none';
  $('totalInfo').style.display = checked > 0 ? 'none' : '';
}

function selectAll() {
  document.querySelectorAll('.unit-cb').forEach(cb => {
    cb.checked = true;
    const unit = document.getElementById('unit-' + cb.dataset.id);
    if (unit) unit.classList.add('selected');
  });
  updateSelCount();
}

function selectNone() {
  document.querySelectorAll('.unit-cb').forEach(cb => {
    cb.checked = false;
    const unit = document.getElementById('unit-' + cb.dataset.id);
    if (unit) unit.classList.remove('selected');
  });
  updateSelCount();
}

/* â•â•â• æŠ•å½±æ¨¡å¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function enterProjector() {
  const checked = [...document.querySelectorAll('.unit-cb:checked')];
  if (checked.length > 0) {
    const selectedIds = new Set(checked.map(cb => cb.dataset.id));
    projData = SHOWN.filter(q => selectedIds.has(q['é¡Œç›®ID'] || q['é¡Œè™Ÿ']));
  } else {
    projData = SHOWN;
  }
  if (!projData.length) { alert('è«‹å…ˆç¯©é¸å‡ºè¦ä¸Šèª²çš„é¡Œç›®'); return; }
  projIdx = 0; projRevealed = false;
  renderSlide();
  $('projector').classList.add('active');
  document.addEventListener('keydown', onKey);
}

function exitProjector() {
  $('projector').classList.remove('active');
  document.removeEventListener('keydown', onKey);
}

function onKey(e) {
  if (e.key === 'Escape') { exitProjector(); return; }
  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    if (!projRevealed) revealQuestion();
    else nextSlide();
  }
  if (e.key === 'ArrowLeft') prevSlide();
  if (e.key === 't' || e.key === 'T') markTaughtInProjector();
}

function renderSlide() {
  const q = projData[projIdx];
  const total = projData.length;

  /* é€²åº¦æ¢ */
  $('projProgress').style.width = `${((projIdx + 1) / total) * 100}%`;

  /* æ¨™é ­ */
  $('projBadges').innerHTML = `
    <span class="badge ${gradeClass(q['å¹´ç´š'])}">${esc(q['å¹´ç´š'])}</span>
    <span class="badge b-yr">${esc(q['å¹´åº¦'])} å¹´ ç¬¬ ${esc(q['é¡Œè™Ÿ'])} é¡Œ</span>
    ${q['é¡åˆ¥']       ? `<span class="badge b-ct">${esc(q['é¡åˆ¥'])}</span>`                     : ''}
    ${q['é›£æ˜“åº¦åˆ†ç´š'] ? `<span class="badge ${diffClass(q['é›£æ˜“åº¦åˆ†ç´š'])}">${esc(q['é›£æ˜“åº¦åˆ†ç´š'])}</span>` : ''}`;
  $('projTitle').textContent   = q['é¡Œç›®é‡é»'] || '';
  $('projCounter').textContent = `${projIdx + 1} / ${total}`;

  /* æ¯”è¼ƒè¡¨ï¼ˆæŠ•å½±å¤§å­—ç‰ˆï¼‰ */
  const tableHtml = buildProjTables(q);

  /* é¡Œç›®å€ */
  const qText = q['å®Œæ•´é¡Œç›®èˆ‡é¸é …'] || '';
  const qHtml = qText ? `
    <div class="proj-question${projRevealed ? '' : ' hidden'}" id="projQ">
      <div class="proj-q-label">ğŸ“ é¡Œç›®èˆ‡é¸é …</div>
      <div class="proj-q-text">${esc(qText)}</div>
    </div>` : '';

  $('projContent').innerHTML = tableHtml + qHtml;

  /* æŒ‰éˆ•ç‹€æ…‹ */
  $('btnPrev').disabled = projIdx === 0;
  $('btnNext').disabled = projIdx === total - 1;
  $('btnReveal').style.display = (projRevealed || !qText) ? 'none' : '';

  /* å·²æ•™éæŒ‰éˆ• */
  const uid       = q['é¡Œç›®ID'] || q['é¡Œè™Ÿ'];
  const taughtBtn = $('btnTaught');
  if (TAUGHT.has(uid)) {
    taughtBtn.textContent = 'âœ… å·²æ•™é';
    taughtBtn.style.background = '#059669';
  } else {
    taughtBtn.textContent = 'â—‹ æ¨™è¨˜å·²æ•™';
    taughtBtn.style.background = '#047857';
  }
}

/* æŠ•å½±ç‰ˆæ¯”è¼ƒè¡¨ï¼ˆå¤§å­—ï¼‰*/
function buildProjTables(q) {
  const parts = [];

  if (q._py.length) parts.push(`
    <div>
      <div class="proj-sec-label">â– ç ´éŸ³å­—æ¯”è¼ƒ</div>
      <table class="proj-tbl">
        <thead><tr><th>ä¾†æº</th><th>ç ´éŸ³å­—</th><th>è©èª</th><th>æ³¨éŸ³</th><th>å­—ç¾©èªªæ˜</th></tr></thead>
        <tbody>${q._py.map(r => `
          <tr>
            <td>${esc(r['ä¾†æº'])}</td>
            <td class="proj-char">${esc(r['ç ´éŸ³å­—'])}</td>
            <td>${esc(r['è©èª'])}</td>
            <td class="proj-reading">${esc(r['æ³¨éŸ³'])}</td>
            <td>${esc(r['å­—ç¾©èªªæ˜'])}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`);

  if (q._cz.length) parts.push(`
    <div>
      <div class="proj-sec-label">â– éŒ¯åˆ¥å­—è¾¨æ</div>
      <table class="proj-tbl">
        <thead><tr><th>æ­£èª¤</th><th>å¥ä¸­å¯«æ³•</th><th>æ­£ç¢ºè©èª</th><th>å­—ç¾©èªªæ˜</th></tr></thead>
        <tbody>${q._cz.map(r => `
          <tr class="${(r['æ­£èª¤']||'').includes('âœ“') ? 'proj-row-ok' : 'proj-row-err'}">
            <td><strong>${esc(r['æ­£èª¤'])}</strong></td>
            <td>${esc(r['éŒ¯èª¤å¯«æ³•'])}</td>
            <td>${esc(r['æ­£ç¢ºè©èª'])}</td>
            <td>${esc(r['å­—ç¾©èªªæ˜'])}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`);

  if (q._xj.length) parts.push(`
    <div>
      <div class="proj-sec-label">â– å½¢è¿‘å­— / åŒéŸ³å­—è¾¨æ</div>
      <table class="proj-tbl">
        <thead><tr><th>å­—</th><th>èªè©</th><th>è§£é‡‹</th></tr></thead>
        <tbody>${q._xj.map(r => `
          <tr>
            <td class="proj-char">${esc(r['å­—'])}</td>
            <td>${esc(r['èªè©'])}</td>
            <td>${esc(r['è§£é‡‹'])}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`);

  return parts.join('');
}

function revealQuestion() {
  projRevealed = true;
  const el = $('projQ');
  if (el) el.classList.remove('hidden');
  $('btnReveal').style.display = 'none';
}

function nextSlide() {
  if (projIdx < projData.length - 1) { projIdx++; projRevealed = false; renderSlide(); }
}

function prevSlide() {
  if (projIdx > 0) { projIdx--; projRevealed = false; renderSlide(); }
}

/* â•â•â• äº‹ä»¶ & å•Ÿå‹• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
['fGrade','fYear','fCat','fDiff','fTaught'].forEach(id => $(id).addEventListener('change', applyFilter));
loadData();
</script>
</body>
</html>
